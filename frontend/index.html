<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StemScribe ✦ Tear The Sound Apart</title>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Space+Grotesk:wght@400;500;600;700&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-deep: #0d0d12;
            --bg-dark: #13131a;
            --bg-card: #1a1a24;
            --psych-orange: #ff7b54;
            --psych-pink: #ff6b9d;
            --psych-purple: #c678dd;
            --psych-blue: #61afef;
            --psych-teal: #56b6c2;
            --psych-yellow: #e5c07b;
            --psych-green: #98c379;
            --cream: #f5f0e8;
            --text: #e8e4df;
            --text-dim: #7a7a85;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-deep);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Psychedelic animated background */
        .psych-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
            overflow: hidden;
        }

        .psych-bg::before {
            content: '';
            position: absolute;
            width: 150%;
            height: 150%;
            top: -25%;
            left: -25%;
            background:
                radial-gradient(ellipse at 20% 30%, rgba(255, 123, 84, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(198, 120, 221, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 60% 20%, rgba(97, 175, 239, 0.1) 0%, transparent 40%),
                radial-gradient(ellipse at 30% 80%, rgba(255, 107, 157, 0.1) 0%, transparent 45%);
            animation: psych-drift 20s ease-in-out infinite;
        }

        @keyframes psych-drift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(2%, -2%) rotate(1deg); }
            50% { transform: translate(-1%, 2%) rotate(-1deg); }
            75% { transform: translate(-2%, -1%) rotate(0.5deg); }
        }

        /* Floating orbs */
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.4;
            animation: float 15s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: var(--psych-orange);
            top: 10%;
            left: -10%;
            animation-delay: 0s;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: var(--psych-purple);
            top: 60%;
            right: -5%;
            animation-delay: -5s;
        }

        .orb-3 {
            width: 250px;
            height: 250px;
            background: var(--psych-teal);
            bottom: 10%;
            left: 30%;
            animation-delay: -10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.05); }
            66% { transform: translate(-20px, 20px) scale(0.95); }
        }

        /* Header */
        .header {
            position: relative;
            z-index: 10;
            padding: 1.5rem 3rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-symbol {
            font-size: 2rem;
            animation: spin-slow 10s linear infinite;
        }

        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .logo-text {
            font-family: 'Righteous', cursive;
            font-size: 1.8rem;
            letter-spacing: 1px;
            background: linear-gradient(135deg, var(--psych-orange), var(--psych-pink), var(--psych-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-links a {
            color: var(--text-dim);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: var(--psych-orange);
        }

        /* Main Container */
        .container {
            position: relative;
            z-index: 1;
            max-width: 1100px;
            margin: 0 auto;
            padding: 4rem 2rem;
        }

        /* Hero */
        .hero {
            text-align: center;
            margin-bottom: 4rem;
        }

        .hero-label {
            display: inline-block;
            font-size: 0.75rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--psych-teal);
            background: rgba(86, 182, 194, 0.1);
            padding: 0.5rem 1.25rem;
            border-radius: 50px;
            border: 1px solid rgba(86, 182, 194, 0.2);
            margin-bottom: 1.5rem;
        }

        .hero h1 {
            font-family: 'Righteous', cursive;
            font-size: 4rem;
            line-height: 1.1;
            margin-bottom: 1.5rem;
            letter-spacing: 1px;
        }

        .hero h1 .highlight {
            background: linear-gradient(135deg, var(--psych-orange) 0%, var(--psych-pink) 50%, var(--psych-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-shift 5s ease infinite;
            background-size: 200% 200%;
        }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .hero p {
            font-family: 'Outfit', sans-serif;
            font-size: 1.2rem;
            color: var(--text-dim);
            max-width: 550px;
            margin: 0 auto;
            line-height: 1.7;
        }

        /* Upload Section */
        .upload-section {
            background: linear-gradient(180deg, rgba(26, 26, 36, 0.7) 0%, rgba(19, 19, 26, 0.8) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 24px;
            padding: 2.5rem;
            margin-bottom: 3rem;
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: rgba(0,0,0,0.3);
            padding: 0.4rem;
            border-radius: 14px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .mode-btn {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-dim);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mode-btn:hover {
            color: var(--text);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, var(--psych-orange), var(--psych-pink));
            color: white;
            box-shadow: 0 4px 20px rgba(255, 123, 84, 0.3);
        }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 4rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .drop-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,123,84,0.03), rgba(198,120,221,0.03));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--psych-orange);
            transform: scale(1.01);
        }

        .drop-zone:hover::before, .drop-zone.dragover::before {
            opacity: 1;
        }

        .drop-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: inline-block;
            animation: bob 3s ease-in-out infinite;
        }

        @keyframes bob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .drop-title {
            font-family: 'Righteous', cursive;
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
        }

        .drop-subtitle {
            font-family: 'Outfit', sans-serif;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        /* Skills Selector */
        .skills-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        .skills-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .skills-title {
            font-family: 'Righteous', cursive;
            font-size: 1rem;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .skills-subtitle {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        .skill-card {
            background: rgba(30, 30, 45, 0.6);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .skill-card:hover {
            border-color: rgba(255,123,84,0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .skill-card.selected {
            border-color: var(--psych-orange);
            background: rgba(255,123,84,0.1);
            box-shadow: 0 0 20px rgba(255,123,84,0.2);
        }

        .skill-card.selected::after {
            content: '✓';
            position: absolute;
            top: 6px;
            right: 8px;
            font-size: 0.8rem;
            color: var(--psych-orange);
        }

        .skill-emoji {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .skill-name {
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-main);
            margin-bottom: 0.25rem;
        }

        .skill-desc {
            font-size: 0.7rem;
            color: var(--text-dim);
            line-height: 1.4;
        }

        .skill-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 0.5rem;
        }

        .skill-tag {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 8px;
            background: rgba(97,218,251,0.15);
            color: var(--psych-cyan);
        }

        .skill-generates {
            font-size: 0.65rem;
            color: var(--psych-pink);
            margin-top: 0.5rem;
            font-style: italic;
        }

        .skills-loading {
            text-align: center;
            padding: 1rem;
            color: var(--text-dim);
        }

        /* Hierarchical Sub-Stems (nested under parent) */
        .stem-card.has-substems {
            position: relative;
        }

        .substems-toggle {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255,123,84,0.2);
            border: 1px solid rgba(255,123,84,0.4);
            color: var(--psych-orange);
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .substems-toggle:hover {
            background: rgba(255,123,84,0.3);
        }

        .substems-toggle.expanded {
            background: var(--psych-orange);
            color: #1a1a24;
        }

        .substems-container {
            display: none;
            grid-column: 1 / -1;
            background: rgba(20, 20, 30, 0.5);
            border-radius: 12px;
            padding: 0.75rem;
            margin: -0.5rem 0 0.5rem 0;
            border: 1px solid rgba(255,123,84,0.2);
        }

        .substems-container.expanded {
            display: block;
        }

        .substems-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
        }

        .substem-mini-card {
            background: rgba(30, 30, 45, 0.8);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .substem-mini-card:hover {
            border-color: rgba(255,123,84,0.4);
            transform: translateY(-2px);
        }

        .substem-mini-card.muted {
            opacity: 0.4;
        }

        .substem-mini-card .emoji {
            font-size: 1.2rem;
        }

        .substem-mini-card .name {
            font-size: 0.65rem;
            color: var(--text-main);
            margin-top: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .substem-mini-card .mini-controls {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-top: 0.4rem;
        }

        .substem-mini-card .mini-btn {
            font-size: 0.55rem;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(40, 40, 60, 0.8);
            color: var(--text-dim);
            cursor: pointer;
        }

        .substem-mini-card .mini-btn:hover {
            background: rgba(60, 60, 80, 0.8);
        }

        .substem-mini-card .mini-btn.active {
            background: var(--psych-orange);
            color: #1a1a24;
            border-color: var(--psych-orange);
        }

        .substem-parent-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .substem-parent-label::before {
            content: '↳';
            color: var(--psych-orange);
        }

        /* URL Input */
        .url-section {
            display: none;
        }

        .url-section.active {
            display: block;
        }

        .url-input-wrapper {
            position: relative;
        }

        .url-input {
            width: 100%;
            padding: 1.25rem 1.5rem;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1rem;
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.08);
            border-radius: 14px;
            color: var(--text);
            transition: all 0.3s;
        }

        .url-input:focus {
            outline: none;
            border-color: var(--psych-purple);
            box-shadow: 0 0 30px rgba(198, 120, 221, 0.15);
        }

        .url-input::placeholder {
            color: var(--text-dim);
        }

        /* Platform Pills */
        .platforms {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1.25rem;
            flex-wrap: wrap;
        }

        .platform-pill {
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 50px;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.3s;
        }

        .platform-pill:hover {
            border-color: var(--psych-teal);
            color: var(--psych-teal);
        }

        .platform-pill.clickable {
            cursor: pointer;
        }

        .platform-pill.clickable:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(86, 182, 194, 0.2);
        }

        /* Archive.org Browse Section */
        .archive-section {
            display: none;
        }

        .archive-section.active {
            display: block;
        }

        .archive-search-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }

        .archive-search {
            width: 100%;
            padding: 1.25rem 1.5rem;
            padding-right: 3rem;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1rem;
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(86, 182, 194, 0.15);
            border-radius: 14px;
            color: var(--text);
            transition: all 0.3s;
        }

        .archive-search:focus {
            outline: none;
            border-color: var(--psych-teal);
            box-shadow: 0 0 30px rgba(86, 182, 194, 0.15);
        }

        .archive-search::placeholder {
            color: var(--text-dim);
        }

        .archive-search-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: var(--psych-teal);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .archive-search-btn:hover {
            background: #4da6b3;
        }

        .archive-search-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .archive-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .archive-filter {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.8rem;
            padding: 0.4rem 0.75rem;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.3s;
        }

        .archive-filter:hover,
        .archive-filter.active {
            border-color: var(--psych-teal);
            color: var(--psych-teal);
        }

        .archive-year-input {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.8rem;
            padding: 0.4rem 0.75rem;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            color: var(--text);
            width: 70px;
            text-align: center;
        }

        .archive-year-input::placeholder {
            color: var(--text-dim);
        }

        .archive-results {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .archive-results::-webkit-scrollbar {
            width: 6px;
        }

        .archive-results::-webkit-scrollbar-track {
            background: transparent;
        }

        .archive-results::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .archive-show-card {
            padding: 1rem;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .archive-show-card:hover {
            border-color: var(--psych-teal);
            background: rgba(86, 182, 194, 0.05);
        }

        .archive-show-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .archive-show-meta {
            font-size: 0.75rem;
            color: var(--text-dim);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .archive-show-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .archive-show-rating {
            color: var(--psych-yellow);
        }

        /* Track list (inside a show detail view) */
        .archive-tracks {
            display: none;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255,255,255,0.06);
        }

        .archive-tracks.active {
            display: block;
        }

        .archive-track-row {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            transition: all 0.2s;
            gap: 0.75rem;
        }

        .archive-track-row:hover {
            background: rgba(86, 182, 194, 0.08);
        }

        .archive-track-num {
            font-size: 0.7rem;
            color: var(--text-dim);
            width: 24px;
            text-align: right;
            flex-shrink: 0;
        }

        .archive-track-title {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text);
        }

        .archive-track-btn {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.7rem;
            padding: 0.3rem 0.75rem;
            background: rgba(86, 182, 194, 0.15);
            border: 1px solid rgba(86, 182, 194, 0.3);
            border-radius: 6px;
            color: var(--psych-teal);
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .archive-track-btn:hover {
            background: var(--psych-teal);
            color: white;
        }

        .archive-process-all-btn {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.85rem;
            padding: 0.6rem 1.25rem;
            background: linear-gradient(135deg, var(--psych-teal), var(--psych-blue));
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            margin-top: 0.75rem;
            transition: all 0.3s;
            width: 100%;
        }

        .archive-process-all-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(86, 182, 194, 0.3);
        }

        .archive-back-btn {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.8rem;
            padding: 0.4rem 0.75rem;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: var(--text-dim);
            cursor: pointer;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .archive-back-btn:hover {
            border-color: var(--text);
            color: var(--text);
        }

        .archive-loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .archive-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        /* Submit Button */
        .submit-btn {
            font-family: 'Righteous', cursive;
            font-size: 1.2rem;
            letter-spacing: 1px;
            padding: 1.25rem 3rem;
            background: linear-gradient(135deg, var(--psych-orange) 0%, var(--psych-pink) 50%, var(--psych-purple) 100%);
            background-size: 200% 200%;
            border: none;
            border-radius: 14px;
            color: white;
            cursor: pointer;
            margin-top: 2rem;
            transition: all 0.4s;
            box-shadow: 0 8px 30px rgba(255, 107, 157, 0.25);
            animation: gradient-shift 5s ease infinite;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 40px rgba(255, 107, 157, 0.35);
        }

        .submit-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        /* Processing Section */
        .processing-section {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .processing-section.active {
            display: block;
        }

        /* Vinyl Spinner */
        .vinyl-spinner {
            width: 180px;
            height: 180px;
            margin: 0 auto 2rem;
            position: relative;
        }

        .vinyl {
            width: 100%;
            height: 100%;
            background:
                /* Center hole */
                radial-gradient(circle at 50% 50%, #0a0a0f 0%, #0a0a0f 8%, transparent 8%),
                /* Label area */
                radial-gradient(circle at 50% 50%, var(--psych-orange) 8%, var(--psych-pink) 18%, transparent 18%),
                /* Inner groove ring */
                radial-gradient(circle at 50% 50%, rgba(40,40,50,1) 18%, rgba(30,30,40,1) 19%, transparent 19%),
                /* Vinyl grooves - more visible */
                repeating-radial-gradient(circle at 50% 50%,
                    rgba(20,20,30,1) 20%,
                    rgba(40,40,55,1) 21%,
                    rgba(25,25,35,1) 22%,
                    rgba(45,45,60,1) 23%,
                    rgba(20,20,30,1) 24%
                ),
                /* Base vinyl color */
                radial-gradient(circle at 30% 30%, #3a3a4a 0%, #1a1a24 100%);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            box-shadow:
                0 0 0 8px #13131a,
                0 0 0 10px rgba(255,255,255,0.08),
                inset 0 0 30px rgba(0,0,0,0.5),
                0 20px 60px rgba(0,0,0,0.6);
        }

        /* Vinyl shine/reflection */
        .vinyl::after {
            content: '';
            position: absolute;
            top: 5%;
            left: 10%;
            width: 30%;
            height: 40%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 60%);
            border-radius: 50%;
            pointer-events: none;
        }

        .vinyl-label {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 65px;
            height: 65px;
            margin-left: -32.5px;
            margin-top: -32.5px;
            background:
                radial-gradient(circle at 50% 50%, #1a1a24 0%, #1a1a24 15%, transparent 15%),
                conic-gradient(from 0deg, var(--psych-orange), var(--psych-pink), var(--psych-purple), var(--psych-orange));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            animation: label-spin 1.5s linear infinite;
        }

        @keyframes label-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .stage-text {
            font-family: 'Righteous', cursive;
            font-size: 1.3rem;
            letter-spacing: 1px;
            background: linear-gradient(135deg, var(--psych-orange), var(--psych-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.75rem;
        }

        .stage-subtitle {
            font-family: 'Outfit', sans-serif;
            color: var(--text-dim);
        }

        /* Progress Bar - Tour Bus Road */
        .progress-container {
            width: 100%;
            max-width: 600px;
            margin: 3rem auto 2rem;
            position: relative;
            padding-top: 100px;
        }

        /* City Skyline Background */
        .city-skyline {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 95px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 10px;
            pointer-events: none;
        }

        .city {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.3;
            transition: all 0.6s ease;
            filter: grayscale(100%);
        }

        .city.visited {
            opacity: 1;
            filter: grayscale(0%);
            transform: scale(1.1);
            animation: city-arrival 0.8s ease-out;
        }

        @keyframes city-arrival {
            0% { transform: scale(1.0); filter: grayscale(100%) brightness(1); }
            30% { transform: scale(1.3); filter: grayscale(0%) brightness(1.8); }
            50% { transform: scale(1.15); filter: brightness(1.4); }
            100% { transform: scale(1.1); filter: brightness(1); }
        }

        /* Neon glow pulse behind visited cities */
        .city.visited::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(255,123,84,0.4) 0%, rgba(255,107,157,0.2) 40%, transparent 70%);
            border-radius: 50%;
            animation: city-glow-pulse 2s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes city-glow-pulse {
            0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
        }

        /* Sparkle particles when visited */
        .city.visited::after {
            content: '✨';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1rem;
            animation: sparkle-float 1.5s ease-out infinite;
            opacity: 0;
        }

        @keyframes sparkle-float {
            0% { opacity: 0; transform: translateX(-50%) translateY(0) scale(0.5); }
            20% { opacity: 1; transform: translateX(-50%) translateY(-5px) scale(1); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px) scale(0.3); }
        }

        .city-name {
            font-size: 0.6rem;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-bottom: 6px;
            color: var(--text-dim);
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            transition: all 0.4s ease;
        }

        .city.visited .city-name {
            color: var(--psych-orange);
            text-shadow: 0 0 10px rgba(255, 123, 84, 0.8), 0 0 20px rgba(255, 123, 84, 0.4);
            animation: neon-flicker 0.5s ease-out, neon-pulse 2s ease-in-out infinite 0.5s;
        }

        @keyframes neon-flicker {
            0% { opacity: 0.4; }
            10% { opacity: 1; }
            20% { opacity: 0.6; }
            30% { opacity: 1; }
            40% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        @keyframes neon-pulse {
            0%, 100% { text-shadow: 0 0 10px rgba(255, 123, 84, 0.8), 0 0 20px rgba(255, 123, 84, 0.4); }
            50% { text-shadow: 0 0 15px rgba(255, 123, 84, 1), 0 0 30px rgba(255, 123, 84, 0.6), 0 0 40px rgba(255, 107, 157, 0.3); }
        }

        /* Window lights twinkle when city is visited */
        .city.visited .building::after {
            animation: window-twinkle 1.5s ease-in-out infinite;
        }

        @keyframes window-twinkle {
            0%, 100% { opacity: 0.8; background-color: rgba(255, 220, 150, 0.9); }
            25% { opacity: 1; background-color: rgba(255, 255, 200, 1); }
            50% { opacity: 0.6; background-color: rgba(255, 200, 100, 0.8); }
            75% { opacity: 0.95; background-color: rgba(255, 240, 180, 0.95); }
        }

        /* Buildings glow when visited */
        .city.visited .building {
            filter: drop-shadow(0 0 8px rgba(255, 200, 100, 0.5));
        }

        /* San Francisco - Golden Gate Bridge (SVG Version) */
        .city-sf .skyline {
            width: 120px;
            height: 70px;
            position: relative;
        }

        .city-sf .guardrail {
            stroke: #c4461c;
            stroke-width: 1;
        }

        .city-sf.visited .guardrail {
            stroke: #ff6b4a;
            filter: drop-shadow(0 0 2px rgba(255, 107, 74, 0.5));
        }

        .city-sf .tower .brace {
            fill: #c4461c;
        }

        .city-sf.visited .tower .brace {
            fill: #ff6b4a;
        }

        /* Suspender cables */
        .city-sf .suspenders line {
            stroke: #c4461c;
            stroke-width: 0.6;
        }

        .city-sf.visited .suspenders line {
            stroke: #ff6b4a;
            filter: drop-shadow(0 0 2px rgba(255, 107, 74, 0.4));
        }

        .city-sf .gg-bridge {
            width: 100%;
            height: 100%;
        }

        /* Water - deep blue bay */
        .city-sf .gg-bridge .water {
            fill: #1a4a6a;
        }

        /* Fog effect */
        .city-sf .fog {
            fill: rgba(200, 215, 230, 0.25);
            animation: sf-fog 6s ease-in-out infinite;
        }

        @keyframes sf-fog {
            0%, 100% { opacity: 0.25; transform: translateX(-3px); }
            50% { opacity: 0.4; transform: translateX(3px); }
        }

        /* Road deck */
        .city-sf .gg-bridge .deck {
            fill: #3a3a3a;
        }

        .city-sf .road-line {
            stroke: #ffcc00;
            stroke-width: 1;
        }

        /* Towers - International Orange #c4461c */
        .city-sf .tower rect {
            fill: #c4461c;
            stroke: #8a2a10;
            stroke-width: 0.5;
        }

        .city-sf .tower .brace {
            stroke: #c4461c;
            stroke-width: 2;
        }

        .city-sf .tower .cap {
            fill: #d85030;
            stroke: #8a2a10;
            stroke-width: 0.5;
        }

        /* Main suspension cable */
        .city-sf .main-cable {
            stroke: #c4461c;
            stroke-width: 2.5;
            stroke-linecap: round;
        }

        /* === VISITED STATE === */
        .city-sf.visited .tower rect {
            fill: #ff6b4a;
            stroke: #e85a38;
            filter: drop-shadow(0 0 8px rgba(255, 100, 50, 0.8));
        }

        .city-sf.visited .tower .brace {
            stroke: #ff6b4a;
            filter: drop-shadow(0 0 5px rgba(255, 107, 74, 0.6));
        }

        .city-sf.visited .tower .cap {
            fill: #ff8866;
            stroke: #e85a38;
        }

        .city-sf.visited .main-cable {
            stroke: #ff6b4a;
            filter: drop-shadow(0 0 5px rgba(255, 107, 74, 0.9));
            animation: cable-glow 2s ease-in-out infinite;
        }

        @keyframes cable-glow {
            0%, 100% { filter: drop-shadow(0 0 5px rgba(255, 107, 74, 0.9)); }
            50% { filter: drop-shadow(0 0 10px rgba(255, 107, 74, 1)); }
        }

        .city-sf.visited .gg-bridge .water {
            fill: #2a6a9a;
        }

        .city-sf.visited .fog {
            fill: rgba(255, 200, 150, 0.15);
        }

        /* Denver - Rocky Mountains (SVG Version) */
        .city-denver .skyline {
            width: 95px;
            height: 55px;
            position: relative;
        }

        .city-denver .rockies {
            width: 100%;
            height: 100%;
        }

        /* Back mountain range - distant, hazier */
        .city-denver .mountain-back {
            fill: #4a5a70;
            opacity: 0.6;
        }

        /* Middle range */
        .city-denver .mountain-mid {
            fill: #5a7090;
            opacity: 0.8;
        }

        /* Front range - main peaks */
        .city-denver .mountain-front {
            fill: #6a88a8;
        }

        /* Snow caps */
        .city-denver .snow {
            fill: #e8f0f8;
        }

        .city-denver .snow-small {
            fill: #dde8f2;
        }

        /* Pine forest */
        .city-denver .trees {
            fill: #1a3828;
        }

        /* Ground */
        .city-denver .ground {
            fill: #2a4038;
        }

        /* === VISITED STATE - Alpenglow === */
        .city-denver.visited .mountain-front {
            fill: #7a98b8;
            filter: drop-shadow(0 0 10px rgba(255, 150, 100, 0.5));
            animation: mountain-glow 3s ease-in-out infinite;
        }

        @keyframes mountain-glow {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(255, 150, 100, 0.5)); }
            50% { filter: drop-shadow(0 0 20px rgba(255, 120, 60, 0.8)); }
        }

        .city-denver.visited .snow {
            fill: #fff5e8;
            filter: drop-shadow(0 0 8px rgba(255, 200, 150, 0.8));
            animation: snow-glow 2s ease-in-out infinite;
        }

        @keyframes snow-glow {
            0%, 100% { fill: #fff5e8; filter: drop-shadow(0 0 8px rgba(255, 200, 150, 0.8)); }
            50% { fill: #ffeecc; filter: drop-shadow(0 0 15px rgba(255, 180, 100, 1)); }
        }

        .city-denver.visited .trees {
            fill: #2a4838;
            filter: drop-shadow(0 -3px 8px rgba(255, 150, 100, 0.3));
        }

        /* Chicago - SVG Skyline (The Windy City) */
        .city-chicago .skyline {
            width: 100px;
            height: 70px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            position: relative;
        }

        .chi-skyline {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        /* Lake Michigan */
        .chi-skyline .lake {
            fill: #3a6080;
            opacity: 0.6;
        }

        /* Building base style */
        .chi-skyline .building {
            fill: #5a7898;
            stroke: #3a4858;
            stroke-width: 0.5;
        }

        /* John Hancock Center */
        .chi-skyline .hancock .building {
            fill: url(#hancock-gradient);
        }

        .chi-skyline .x-brace {
            stroke: #1a2838;
            stroke-width: 1.5;
            opacity: 0.7;
        }

        /* Willis/Sears Tower */
        .chi-skyline .willis .building {
            fill: #2a3848;
        }

        .chi-skyline .antenna {
            stroke: #8a9aa8;
            stroke-width: 1.5;
        }

        .chi-skyline .beacon {
            fill: #cc3333;
            opacity: 0.5;
        }

        /* Aon Center */
        .chi-skyline .aon .building {
            fill: #d8e0e8;
            stroke: #a0b0c0;
        }

        /* Other buildings */
        .chi-skyline .other-buildings .building {
            fill: #6a8098;
            stroke: #4a5868;
            stroke-width: 0.3;
        }

        /* Window patterns */
        .chi-skyline .windows {
            stroke: rgba(255, 240, 180, 0.15);
            stroke-width: 0.3;
        }

        /* === VISITED STATE === */
        .city-chicago.visited .chi-skyline .building {
            filter: drop-shadow(0 0 6px rgba(255, 200, 100, 0.4));
        }

        .city-chicago.visited .beacon {
            fill: #ff4444;
            opacity: 1;
            animation: chi-beacon 1.2s ease-in-out infinite;
        }

        .city-chicago.visited .right-beacon {
            animation-delay: 0.6s;
        }

        @keyframes chi-beacon {
            0%, 45%, 100% {
                opacity: 0.4;
                filter: drop-shadow(0 0 2px rgba(255, 50, 50, 0.5));
            }
            50%, 95% {
                opacity: 1;
                filter: drop-shadow(0 0 8px rgba(255, 50, 50, 1));
            }
        }

        .city-chicago.visited .lake {
            fill: #4a7898;
            animation: lake-shimmer 4s ease-in-out infinite;
        }

        @keyframes lake-shimmer {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.8; }
        }

        .city-chicago.visited .willis .building {
            fill: #3a4858;
            filter: drop-shadow(0 0 10px rgba(255, 180, 100, 0.5));
        }

        .city-chicago.visited .hancock .building {
            filter: drop-shadow(0 0 8px rgba(255, 180, 100, 0.4));
        }

        .city-chicago.visited .aon .building {
            fill: #e8f0f8;
            filter: drop-shadow(0 0 12px rgba(255, 255, 255, 0.6));
        }

        /* NYC - Detailed Skyline */
        .city-nyc .skyline {
            width: 85px;
            height: 70px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 2px;
            position: relative;
        }

        .city-nyc .building {
            background: linear-gradient(180deg, #8aa8c8 0%, #506888 100%);
            border-radius: 2px 2px 0 0;
            position: relative;
            box-shadow: 1px 0 2px rgba(0,0,0,0.3);
        }

        /* Window lights */
        .city-nyc .building::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 1px;
            right: 1px;
            bottom: 4px;
            background: repeating-linear-gradient(180deg,
                rgba(255,255,200,0.25) 0px, rgba(255,255,200,0.25) 2px,
                transparent 2px, transparent 5px);
        }

        .city-nyc .b1 { width: 8px; height: 32px; }
        .city-nyc .b2 { width: 10px; height: 45px; }

        .city-nyc .empire {
            width: 14px;
            height: 62px;
            background: linear-gradient(180deg, #a0b8d8 0%, #607898 100%);
        }
        .city-nyc .empire::before {
            content: '';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 12px;
            background: linear-gradient(180deg, #c8d8e8 0%, #a0b8d8 100%);
        }

        .city-nyc .chrysler {
            width: 12px;
            height: 55px;
            background: linear-gradient(180deg, #b0c8e0 0%, #708898 100%);
        }
        .city-nyc .chrysler::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-width: 0 6px 10px 6px;
            border-style: solid;
            border-color: transparent transparent #b0c8e0 transparent;
        }

        .city-nyc .owtc {
            width: 10px;
            height: 58px;
            background: linear-gradient(180deg, #90a8c0 0%, #607080 100%);
        }
        .city-nyc .b5 { width: 8px; height: 38px; }

        /* King Kong climbing the Empire State! */
        .city-nyc .king-kong {
            position: absolute;
            left: 28px;
            bottom: 42px;
            width: 10px;
            height: 12px;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .city-nyc.visited .king-kong {
            opacity: 1;
            animation: kong-climb 3s ease-in-out infinite;
        }

        @keyframes kong-climb {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-4px) rotate(5deg); }
        }

        /* Kong's body */
        .king-kong .kong-body {
            width: 8px;
            height: 8px;
            background: radial-gradient(ellipse at 40% 30%, #4a3a2a 0%, #2a1a0a 100%);
            border-radius: 40% 40% 50% 50%;
            position: absolute;
            bottom: 0;
        }

        /* Kong's head */
        .king-kong .kong-head {
            width: 6px;
            height: 5px;
            background: radial-gradient(ellipse at 40% 30%, #3a2a1a 0%, #1a0a00 100%);
            border-radius: 50% 50% 40% 40%;
            position: absolute;
            bottom: 7px;
            left: 1px;
        }

        /* Kong's face */
        .king-kong .kong-head::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 1px;
            width: 4px;
            height: 3px;
            background: #5a4a3a;
            border-radius: 0 0 50% 50%;
        }

        /* Kong's arms reaching */
        .king-kong .kong-arm {
            position: absolute;
            width: 3px;
            height: 6px;
            background: #3a2a1a;
            border-radius: 2px;
        }

        .king-kong .kong-arm.left {
            bottom: 5px;
            left: -2px;
            transform: rotate(30deg);
        }

        .king-kong .kong-arm.right {
            bottom: 6px;
            right: -1px;
            transform: rotate(-45deg);
        }

        /* The Biplane buzzing around! */
        .city-nyc .biplane {
            position: absolute;
            width: 16px;
            height: 8px;
            z-index: 15;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .city-nyc.visited .biplane {
            opacity: 1;
            animation: biplane-circle 4s linear infinite;
        }

        @keyframes biplane-circle {
            0% {
                top: -5px;
                right: 10px;
                transform: rotate(15deg);
            }
            25% {
                top: 15px;
                right: -15px;
                transform: rotate(-10deg) scaleX(-1);
            }
            50% {
                top: 35px;
                right: 5px;
                transform: rotate(-15deg) scaleX(-1);
            }
            75% {
                top: 10px;
                right: 25px;
                transform: rotate(10deg);
            }
            100% {
                top: -5px;
                right: 10px;
                transform: rotate(15deg);
            }
        }

        /* Biplane body */
        .biplane .plane-body {
            position: absolute;
            width: 12px;
            height: 4px;
            background: linear-gradient(180deg, #d4a556 0%, #b8944a 100%);
            border-radius: 6px 2px 2px 6px;
            top: 2px;
            left: 0;
        }

        /* Biplane wings (stacked) */
        .biplane .plane-wings {
            position: absolute;
            width: 14px;
            height: 2px;
            background: #e8c878;
            top: 0;
            left: 1px;
            border-radius: 1px;
            box-shadow: 0 6px 0 #e8c878;
        }

        /* Propeller */
        .biplane .plane-prop {
            position: absolute;
            width: 2px;
            height: 6px;
            background: #888;
            left: 11px;
            top: 1px;
            border-radius: 1px;
            animation: prop-spin 0.1s linear infinite;
        }

        @keyframes prop-spin {
            0% { transform: scaleY(1); }
            50% { transform: scaleY(0.3); }
            100% { transform: scaleY(1); }
        }

        /* Tail */
        .biplane .plane-tail {
            position: absolute;
            width: 4px;
            height: 3px;
            background: #d4a556;
            left: -2px;
            top: 1px;
            clip-path: polygon(100% 0, 100% 100%, 0 50%);
        }

        /* Antenna warning light on Empire State - blinks when visited */
        .city-nyc.visited .empire::after {
            content: '';
            position: absolute;
            top: -14px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #ff3333;
            box-shadow: 0 0 6px 2px rgba(255, 50, 50, 0.8);
            animation: antenna-blink 1s ease-in-out infinite;
        }

        @keyframes antenna-blink {
            0%, 100% { opacity: 1; box-shadow: 0 0 6px 2px rgba(255, 50, 50, 0.8); }
            50% { opacity: 0.3; box-shadow: 0 0 3px 1px rgba(255, 50, 50, 0.4); }
        }

        /* NYC skyline glow when visited - Times Square neon vibes */
        .city-nyc.visited .building {
            filter: drop-shadow(0 0 8px rgba(255, 200, 100, 0.4));
            animation: nyc-nightlife 2s ease-in-out infinite;
        }

        @keyframes nyc-nightlife {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(255, 200, 100, 0.4)); }
            25% { filter: drop-shadow(0 0 12px rgba(255, 107, 157, 0.5)); }
            50% { filter: drop-shadow(0 0 15px rgba(97, 218, 251, 0.5)); }
            75% { filter: drop-shadow(0 0 12px rgba(255, 123, 84, 0.5)); }
        }

        /* Empire State gets special treatment */
        .city-nyc.visited .empire {
            background: linear-gradient(180deg, #d8e8f8 0%, #a8c8e8 100%);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3), 0 0 40px rgba(97, 218, 251, 0.2);
        }

        /* Chicago - Windy City lights up blue */
        .city-chicago.visited .building {
            filter: drop-shadow(0 0 10px rgba(97, 175, 239, 0.5));
            animation: chicago-lights 2s ease-in-out infinite;
        }

        @keyframes chicago-lights {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(97, 175, 239, 0.5)); }
            50% { filter: drop-shadow(0 0 18px rgba(97, 175, 239, 0.8)) drop-shadow(0 0 30px rgba(97, 175, 239, 0.3)); }
        }

        /* Willis Tower antenna blinks */
        .city-chicago.visited .willis::before {
            animation: willis-beacon 1s ease-in-out infinite;
        }

        @keyframes willis-beacon {
            0%, 100% { box-shadow: 0 0 4px 2px rgba(255, 50, 50, 0.8); opacity: 1; }
            50% { box-shadow: 0 0 8px 4px rgba(255, 50, 50, 1); opacity: 0.6; }
        }

        /* Chicago windows glow warmer */
        .city-chicago.visited .building::after {
            background: linear-gradient(180deg,
                transparent 0%, transparent 10%,
                rgba(255, 220, 150, 0.9) 10%, rgba(255, 220, 150, 0.9) 20%,
                transparent 20%, transparent 30%,
                rgba(255, 200, 100, 0.8) 30%, rgba(255, 200, 100, 0.8) 40%,
                transparent 40%, transparent 50%,
                rgba(255, 230, 180, 0.9) 50%, rgba(255, 230, 180, 0.9) 60%,
                transparent 60%
            );
        }

        .progress-road {
            width: 100%;
            height: 40px;
            background: linear-gradient(180deg, #2a2a35 0%, #1a1a24 50%, #2a2a35 100%);
            border-radius: 20px;
            position: relative;
            border: 2px solid rgba(255,255,255,0.1);
            /* Don't clip - let the bus overflow */
        }

        /* Road markings container - this gets clipped */
        .progress-road::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: repeating-linear-gradient(90deg,
                var(--psych-yellow) 0px, var(--psych-yellow) 30px,
                transparent 30px, transparent 60px);
            transform: translateY(-50%);
            opacity: 0.8;
            animation: road-scroll 0.4s linear infinite;
            background-size: 60px 4px;
        }

        @keyframes road-scroll {
            0% { background-position: 0 0; }
            100% { background-position: -60px 0; }
        }

        /* Road edge shadow */
        .progress-road::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 20px;
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.5), inset 0 -2px 6px rgba(0,0,0,0.3);
            pointer-events: none;
            z-index: 1;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--psych-orange), var(--psych-pink), var(--psych-purple), var(--psych-blue));
            background-size: 300% 100%;
            transition: width 0.5s ease-out;
            border-radius: 18px;
            transition: width 0.3s ease;
            animation: rainbow-road 3s linear infinite;
            position: relative;
        }

        @keyframes rainbow-road {
            0% { background-position: 0% 50%; }
            100% { background-position: 300% 50%; }
        }

        /* The Tour Bus - Luxury Prevost Style */
        .tour-bus {
            position: absolute;
            top: -45px;
            left: 0%;
            transform: translateX(-50%);
            width: 120px;
            height: 70px;
            transition: left 0.3s ease;
            z-index: 10;
            animation: bus-cruise 0.5s ease-in-out infinite;
        }

        @keyframes bus-cruise {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-2px); }
        }

        /* Bus body - Sleek black luxury coach */
        .bus-body {
            position: absolute;
            bottom: 14px;
            left: 5px;
            width: 105px;
            height: 42px;
            background: linear-gradient(180deg,
                #2a2a30 0%,
                #1a1a20 20%,
                #0f0f12 50%,
                #1a1a20 80%,
                #252530 100%
            );
            border-radius: 6px 6px 3px 3px;
            border: 1px solid #3a3a44;
            box-shadow:
                0 4px 12px rgba(0,0,0,0.7),
                inset 0 1px 0 rgba(255,255,255,0.1),
                inset 0 -1px 0 rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Chrome trim stripe */
        .bus-body::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(180deg,
                #888 0%, #ccc 30%, #fff 50%, #ccc 70%, #888 100%);
            box-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* Accent stripe - can be custom color */
        .bus-body::after {
            content: '';
            position: absolute;
            top: calc(50% + 4px);
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg,
                var(--psych-purple), var(--psych-pink), var(--psych-orange));
        }

        /* Running lights along bottom */
        .bus-running-lights {
            position: absolute;
            bottom: 2px;
            left: 15px;
            right: 15px;
            height: 2px;
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .running-light {
            width: 4px;
            height: 2px;
            background: #ffaa00;
            border-radius: 1px;
            box-shadow: 0 0 4px 1px rgba(255, 170, 0, 0.6);
            animation: running-light-pulse 1s ease-in-out infinite;
        }

        .running-light:nth-child(2n) { animation-delay: 0.5s; }

        @keyframes running-light-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Bus windows - Dark tinted luxury style */
        .bus-windows {
            position: absolute;
            top: 6px;
            left: 12px;
            right: 20px;
            height: 16px;
            display: flex;
            gap: 2px;
        }

        .bus-window {
            flex: 1;
            background: linear-gradient(180deg,
                #1a2030 0%,
                #2a3040 30%,
                #354050 50%,
                #2a3040 70%,
                #1a2030 100%);
            border-radius: 2px;
            border: 1px solid #4a4a54;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
        }

        /* Tinted glass reflection */
        .bus-window::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(180deg,
                rgba(255,255,255,0.15) 0%,
                transparent 100%);
        }

        /* People silhouettes in windows */
        .bus-person {
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 10px;
            opacity: 0.7;
            animation: person-sway 2s ease-in-out infinite;
        }

        .bus-person .head {
            width: 5px;
            height: 5px;
            background: #3a3a44;
            border-radius: 50%;
            margin: 0 auto 1px;
        }

        .bus-person .body {
            width: 7px;
            height: 5px;
            background: #3a3a44;
            border-radius: 2px 2px 0 0;
            margin: 0 auto;
        }

        /* Different animation timings */
        .bus-window:nth-child(1) .bus-person { animation-delay: 0s; }
        .bus-window:nth-child(2) .bus-person { animation-delay: 0.4s; }
        .bus-window:nth-child(3) .bus-person { animation-delay: 0.8s; }
        .bus-window:nth-child(4) .bus-person { animation-delay: 1.2s; }

        @keyframes person-sway {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-1px); }
        }

        /* Arms not visible through tinted glass */
        .bus-person .arm { display: none; }

        /* ROOFTOP - AC Units & Luggage Bay (more realistic) */
        .bus-roof {
            position: absolute;
            top: 8px;
            left: 15px;
            right: 25px;
            height: 6px;
            background: linear-gradient(180deg, #3a3a44 0%, #2a2a30 100%);
            border-radius: 3px 3px 0 0;
            display: flex;
            gap: 8px;
            padding: 0 5px;
            align-items: center;
            justify-content: center;
        }

        /* AC units on roof */
        .roof-rider {
            display: none; /* Hide the people for cleaner look */
        }

        .bus-roof::before {
            content: '';
            width: 15px;
            height: 4px;
            background: linear-gradient(180deg, #555 0%, #3a3a40 100%);
            border-radius: 1px;
            box-shadow: 20px 0 0 #3a3a40, 40px 0 0 #3a3a40;
        }

        /* Bus front - Aerodynamic luxury style */
        .bus-front {
            position: absolute;
            bottom: 14px;
            right: 0;
            width: 18px;
            height: 42px;
            background: linear-gradient(90deg,
                #1a1a20 0%,
                #2a2a30 40%,
                #3a3a44 100%);
            border-radius: 0 12px 6px 0;
            border: 1px solid #4a4a54;
            border-left: none;
        }

        /* Windshield */
        .bus-front::before {
            content: '';
            position: absolute;
            top: 4px;
            right: 2px;
            width: 12px;
            height: 18px;
            background: linear-gradient(180deg,
                #1a2030 0%,
                #2a3545 50%,
                #1a2030 100%);
            border-radius: 2px 8px 4px 2px;
            border: 1px solid #4a4a54;
        }

        /* Headlights - Modern LED style */
        .bus-front::after {
            content: '';
            position: absolute;
            bottom: 4px;
            right: 3px;
            width: 10px;
            height: 6px;
            background: linear-gradient(180deg, #fff 0%, #ffffcc 50%, #fff 100%);
            border-radius: 2px;
            box-shadow:
                0 0 10px 4px rgba(255, 255, 255, 0.9),
                0 0 20px 8px rgba(255, 255, 200, 0.5),
                15px 0 30px 10px rgba(255, 255, 200, 0.3);
            animation: led-headlight 2s ease-in-out infinite;
        }

        @keyframes led-headlight {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }

        /* Bus wheels - Chrome alloy style */
        .bus-wheel {
            position: absolute;
            bottom: 4px;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle at 35% 35%,
                #4a4a4a 0%,
                #2a2a2a 40%,
                #1a1a1a 70%,
                #0a0a0a 100%);
            border-radius: 50%;
            border: 2px solid #1a1a1a;
            box-shadow:
                0 3px 8px rgba(0,0,0,0.7),
                inset 0 1px 2px rgba(255,255,255,0.1);
            animation: wheel-spin 0.25s linear infinite;
        }

        .bus-wheel.front { left: 15px; }
        .bus-wheel.back { left: 80px; }

        @keyframes wheel-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Chrome hub cap */
        .bus-wheel::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: radial-gradient(circle at 30% 30%,
                #fff 0%, #ccc 20%, #999 50%, #666 80%, #444 100%);
            border-radius: 50%;
            border: 1px solid #888;
        }

        /* Chrome spokes */
        .bus-wheel::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background:
                linear-gradient(0deg, transparent 45%, #777 48%, #777 52%, transparent 55%),
                linear-gradient(60deg, transparent 45%, #777 48%, #777 52%, transparent 55%),
                linear-gradient(120deg, transparent 45%, #777 48%, #777 52%, transparent 55%);
            border-radius: 50%;
        }

        /* LED destination sign */
        .bus-sign {
            position: absolute;
            top: 16px;
            left: 14px;
            background: #0a0a0f;
            color: #ff6b00;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.4rem;
            font-weight: 700;
            padding: 1px 4px;
            border-radius: 2px;
            white-space: nowrap;
            letter-spacing: 0.5px;
            border: 1px solid #333;
            text-shadow: 0 0 4px #ff6b00;
            box-shadow: inset 0 0 3px rgba(255, 107, 0, 0.3);
            z-index: 5;
            animation: sign-flicker 3s ease-in-out infinite;
        }

        @keyframes sign-flicker {
            0%, 100% { opacity: 1; }
            92% { opacity: 1; }
            93% { opacity: 0.7; }
            94% { opacity: 1; }
            95% { opacity: 0.8; }
            96% { opacity: 1; }
        }

        /* Side mirror */
        .bus-mirror {
            position: absolute;
            top: 18px;
            right: -4px;
            width: 6px;
            height: 4px;
            background: linear-gradient(90deg, #2a2a30 0%, #4a4a54 100%);
            border-radius: 1px;
            z-index: 6;
        }

        .bus-mirror::before {
            content: '';
            position: absolute;
            right: -3px;
            top: 0;
            width: 4px;
            height: 4px;
            background: linear-gradient(135deg, #1a2030 0%, #2a3545 50%, #3a4555 100%);
            border: 1px solid #4a4a54;
            border-radius: 1px;
        }

        /* Chrome mud flaps */
        .bus-mud-flap {
            position: absolute;
            bottom: 8px;
            width: 4px;
            height: 10px;
            background: linear-gradient(180deg, #666 0%, #888 50%, #666 100%);
            border-radius: 0 0 2px 2px;
            z-index: 3;
        }

        .bus-mud-flap.front { left: 34px; }
        .bus-mud-flap.back { left: 99px; }

        /* Custom band artwork wrap - premium look */
        .bus-wrap {
            position: absolute;
            bottom: 6px;
            left: 10px;
            right: 18px;
            height: 12px;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(138, 43, 226, 0.15) 10%,
                rgba(255, 105, 180, 0.2) 30%,
                rgba(255, 165, 0, 0.15) 50%,
                rgba(0, 206, 209, 0.2) 70%,
                rgba(138, 43, 226, 0.15) 90%,
                transparent 100%
            );
            border-radius: 2px;
            opacity: 0.8;
            pointer-events: none;
        }

        /* Exhaust - subtle diesel smoke */
        .bus-exhaust {
            position: absolute;
            bottom: 18px;
            left: -8px;
            width: 16px;
            height: 10px;
        }

        .smoke-puff {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: diesel-puff 1s ease-out infinite;
        }

        /* Subtle gray diesel smoke */
        .smoke-puff:nth-child(1) {
            left: 0;
            animation-delay: 0s;
            background: radial-gradient(circle, rgba(100,100,100,0.5) 0%, rgba(80,80,80,0.2) 50%, transparent 70%);
        }
        .smoke-puff:nth-child(2) {
            left: -6px;
            animation-delay: 0.3s;
            background: radial-gradient(circle, rgba(90,90,90,0.4) 0%, rgba(70,70,70,0.15) 50%, transparent 70%);
        }
        .smoke-puff:nth-child(3) {
            left: -12px;
            animation-delay: 0.6s;
            background: radial-gradient(circle, rgba(80,80,80,0.3) 0%, rgba(60,60,60,0.1) 50%, transparent 70%);
        }

        @keyframes diesel-puff {
            0% { opacity: 0.8; transform: scale(0.4) translateY(0); }
            50% { opacity: 0.4; transform: scale(1) translateY(-6px) translateX(-4px); }
            100% { opacity: 0; transform: scale(1.8) translateY(-15px) translateX(-10px); }
        }

        /* Psychedelic smoke trail */
        .bus-trail {
            position: absolute;
            top: 50%;
            left: 0;
            height: 20px;
            transform: translateY(-50%);
            background: linear-gradient(90deg,
                transparent,
                rgba(198, 120, 221, 0.3),
                rgba(255, 107, 157, 0.4),
                rgba(255, 123, 84, 0.5)
            );
            border-radius: 10px;
            transition: width 0.3s ease;
            filter: blur(4px);
        }

        .progress-text {
            font-family: 'Righteous', cursive;
            font-size: 1.5rem;
            margin-top: 1.5rem;
            background: linear-gradient(135deg, var(--psych-orange), var(--psych-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .progress-label {
            font-family: 'Outfit', sans-serif;
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-top: 0.5rem;
            font-style: italic;
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .results-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .results-header h2 {
            font-family: 'Righteous', cursive;
            font-size: 2rem;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .results-header h2 span {
            background: linear-gradient(135deg, var(--psych-green), var(--psych-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Song Card */
        .song-card {
            background: rgba(26, 26, 36, 0.6);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .song-thumb {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .song-details h3 {
            font-family: 'Righteous', cursive;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .song-details p {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .info-toggle-btn {
            margin-left: auto;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .info-toggle-btn:hover {
            background: rgba(198, 120, 221, 0.2);
            border-color: var(--psych-purple);
        }

        .info-toggle-btn.active {
            background: var(--psych-purple);
            border-color: var(--psych-purple);
        }

        /* Track Info Panel */
        .track-info-panel {
            background: linear-gradient(180deg, rgba(30, 25, 40, 0.95) 0%, rgba(20, 18, 30, 0.98) 100%);
            border: 1px solid rgba(198, 120, 221, 0.2);
            border-radius: 16px;
            margin-bottom: 2rem;
            overflow: hidden;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: rgba(198, 120, 221, 0.1);
            border-bottom: 1px solid rgba(198, 120, 221, 0.2);
        }

        .info-header h3 {
            font-family: 'Righteous', cursive;
            font-size: 1rem;
            color: var(--psych-purple);
        }

        .info-close-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem 0.5rem;
            transition: color 0.2s;
        }

        .info-close-btn:hover {
            color: var(--text);
        }

        .info-content {
            padding: 1.5rem;
        }

        .info-loading {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--text-dim);
            padding: 1rem;
        }

        .info-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(198, 120, 221, 0.3);
            border-top-color: var(--psych-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .info-section {
            margin-bottom: 1.5rem;
        }

        .info-section:last-child {
            margin-bottom: 0;
        }

        .info-section h4 {
            font-size: 0.85rem;
            color: var(--psych-teal);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-section p {
            color: var(--text);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .info-section a {
            color: var(--psych-purple);
            font-size: 0.85rem;
            text-decoration: none;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .info-section a:hover {
            text-decoration: underline;
        }

        #membersList, #personnelList {
            display: grid;
            gap: 0.75rem;
        }

        .album-info, .era-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .album-name {
            font-family: 'Righteous', cursive;
            font-size: 1.1rem;
            color: var(--psych-yellow);
        }

        .album-year {
            background: var(--psych-yellow);
            color: var(--bg-dark);
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .album-desc {
            font-style: italic;
            color: var(--text-dim);
        }

        .era-keyboardist {
            font-weight: 600;
            color: var(--psych-pink);
        }

        .era-years {
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        .era-notes {
            font-style: italic;
            color: var(--text-dim);
        }

        .personnel-item {
            background: rgba(229, 192, 123, 0.1);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border-left: 3px solid var(--psych-yellow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .personnel-item .name {
            font-weight: 600;
            color: var(--psych-yellow);
            font-size: 0.85rem;
        }

        .personnel-item .role {
            color: var(--text-dim);
            font-size: 0.8rem;
        }

        .member-item {
            background: rgba(255,255,255,0.03);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border-left: 3px solid var(--psych-orange);
        }

        .member-item .name {
            font-weight: 600;
            color: var(--psych-orange);
            font-size: 0.9rem;
        }

        .member-item .role {
            color: var(--text-dim);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        #stemTipsList {
            display: grid;
            gap: 0.5rem;
        }

        .stem-tip {
            background: rgba(152, 195, 121, 0.1);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border-left: 3px solid var(--psych-green);
        }

        .stem-tip .stem-name {
            font-weight: 600;
            color: var(--psych-green);
            font-size: 0.85rem;
            text-transform: capitalize;
        }

        .stem-tip .tip-text {
            color: var(--text);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        /* Master Transport */
        .master-transport {
            background: linear-gradient(180deg, rgba(26, 26, 36, 0.9) 0%, rgba(19, 19, 26, 0.95) 100%);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 20px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
        }

        .transport-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .play-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--psych-orange), var(--psych-pink));
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(255, 107, 157, 0.3);
        }

        .play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(255, 107, 157, 0.4);
        }

        .skip-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--text-main);
            transition: all 0.2s;
        }

        .skip-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }

        .skip-btn:active {
            transform: scale(0.95);
        }

        .timeline-container {
            flex: 1;
        }

        .timeline {
            width: 100%;
            height: 10px;
            background: rgba(0,0,0,0.4);
            border-radius: 5px;
            cursor: pointer;
            position: relative;
            margin-bottom: 0.5rem;
            /* Larger click area */
            padding: 8px 0;
            margin: -8px 0;
            box-sizing: content-box;
            background-clip: content-box;
        }

        .timeline-progress {
            height: 10px;
            background: linear-gradient(90deg, var(--psych-orange), var(--psych-pink));
            border-radius: 5px;
            width: 0%;
            pointer-events: none;
        }

        .timeline-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #fff 0%, #ddd 100%);
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            cursor: grab;
            border: 2px solid var(--psych-pink);
            transition: transform 0.1s, box-shadow 0.1s;
            z-index: 10;
        }

        .timeline-handle:hover {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 3px 12px rgba(255, 107, 157, 0.5);
        }

        .timeline:hover .timeline-handle {
            transform: translate(-50%, -50%) scale(1.1);
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .master-volume {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .master-volume span {
            font-size: 1.2rem;
        }

        .volume-slider {
            -webkit-appearance: none;
            width: 100px;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--psych-teal);
            border-radius: 50%;
            cursor: pointer;
        }

        /* ============================================
           VINTAGE NEVE CONSOLE MIXER
           ============================================ */

        /* Neve Console Container */
        .neve-console {
            background: linear-gradient(180deg, #2a2520 0%, #1e1a16 100%);
            border: 4px solid #3d352d;
            border-radius: 12px;
            padding: 1.5rem;
            padding-bottom: 2.5rem;
            box-shadow:
                inset 0 2px 4px rgba(255,255,255,0.05),
                0 20px 60px rgba(0,0,0,0.5);
            position: relative;
            margin: 0 30px;
        }

        /* Leather Armrest - Bigger & Beefier */
        .neve-armrest {
            position: absolute;
            bottom: -28px;
            left: -16px;
            right: -16px;
            height: 50px;
            background: linear-gradient(180deg,
                #5a4838 0%,
                #4a3828 10%,
                #3d2d1f 25%,
                #2a1f14 60%,
                #1f170f 85%,
                #15100a 100%
            );
            border-radius: 10px 10px 16px 16px;
            border: 3px solid #1a1410;
            box-shadow:
                inset 0 3px 6px rgba(255,255,255,0.12),
                inset 0 -3px 10px rgba(0,0,0,0.6),
                0 10px 30px rgba(0,0,0,0.6);
        }

        /* Leather stitching - double row */
        .neve-armrest::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 30px;
            right: 30px;
            height: 12px;
            background:
                repeating-linear-gradient(90deg,
                    #6a5a48 0px, #6a5a48 10px,
                    transparent 10px, transparent 16px
                ),
                repeating-linear-gradient(90deg,
                    #6a5a48 0px, #6a5a48 10px,
                    transparent 10px, transparent 16px
                );
            background-size: 100% 1px;
            background-position: 0 0, 0 10px;
            background-repeat: repeat-x;
        }

        /* Leather texture/grain */
        .neve-armrest::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.1;
            border-radius: 10px;
            pointer-events: none;
        }

        /* Armrest bolster ends - bigger */
        .neve-armrest-end {
            position: absolute;
            top: 6px;
            bottom: 6px;
            width: 35px;
            background: linear-gradient(180deg, #4a3828 0%, #3d2d1f 30%, #2a1f14 70%, #1f170f 100%);
            border-radius: 8px;
            box-shadow:
                inset 0 2px 4px rgba(255,255,255,0.08),
                inset 0 -2px 8px rgba(0,0,0,0.5);
        }

        .neve-armrest-end.left { left: 10px; }
        .neve-armrest-end.right { right: 10px; }

        /* Wood side panels */
        .neve-console::before,
        .neve-console::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 20px;
            background: linear-gradient(90deg, #4a3c2e 0%, #6b5a48 50%, #4a3c2e 100%);
            border-radius: 8px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .neve-console::before { left: -24px; }
        .neve-console::after { right: -24px; }

        /* Console screws */
        .neve-screw {
            position: absolute;
            width: 10px;
            height: 10px;
            background: radial-gradient(circle at 30% 30%, #8a8278 0%, #4a4540 50%, #3d352d 100%);
            border-radius: 50%;
            border: 1px solid #2a2520;
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.2);
        }

        .neve-screw::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 2px;
            right: 2px;
            height: 1px;
            background: #2a2520;
            transform: rotate(45deg);
        }

        /* Channel Strip Grid */
        .stems-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0;
            background: #1a1612;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #3d352d;
        }

        @media (max-width: 1100px) {
            .stems-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 700px) {
            .stems-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Neve Channel Strip */
        .stem-card {
            background: linear-gradient(180deg, #d4cfc6 0%, #c4beb4 30%, #b8b2a8 100%);
            border-right: 1px solid #8a8278;
            border-left: 1px solid #f0ebe2;
            padding: 0.75rem 0.5rem 1rem;
            text-align: center;
            transition: all 0.2s;
            position: relative;
            min-height: 460px;
        }

        .stem-card:first-child {
            border-radius: 6px 0 0 6px;
        }

        .stem-card:last-child {
            border-radius: 0 6px 6px 0;
            border-right: none;
        }

        .stem-card::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.1), transparent);
        }

        .stem-card:hover {
            transform: none;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.1);
        }

        .stem-card.muted {
            opacity: 0.6;
        }

        .stem-card.muted .led-meter-fill {
            opacity: 0.3;
        }

        /* Cascaded Stem Styling */
        .stem-card.cascaded-stem {
            background: linear-gradient(180deg, #e8e0f5 0%, #d8d0e5 30%, #c8c0d5 100%);
            border-color: rgba(198, 120, 221, 0.3);
            min-height: 420px;
        }

        .cascade-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.7rem;
            background: linear-gradient(135deg, var(--psych-purple), var(--psych-pink));
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 5;
        }

        .cascade-stems-header {
            background: linear-gradient(90deg, transparent, rgba(198,120,221,0.1), transparent);
        }

        /* Channel Label */
        .stem-icon {
            font-size: 1.3rem;
            margin-bottom: 0.25rem;
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2));
        }

        .stem-name {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: #2a2520;
            margin-bottom: 0.5rem;
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
        }

        .stem-original {
            font-size: 0.5rem;
            font-weight: 400;
            opacity: 0.7;
            display: block;
            text-transform: capitalize;
            letter-spacing: 0.5px;
        }

        /* LED Bar Meter (Neve Style) - Now beside fader */
        .led-meter {
            width: 16px;
            height: 120px;
            background: linear-gradient(180deg, #0a0908 0%, #151310 100%);
            border-radius: 3px;
            border: 2px solid #3d352d;
            position: relative;
            box-shadow:
                inset 0 2px 8px rgba(0,0,0,0.9),
                0 2px 4px rgba(0,0,0,0.3);
            padding: 2px;
            flex-shrink: 0;
            margin-top: 8px;
        }

        /* LED segments container */
        .led-meter-track {
            width: 100%;
            height: 100%;
            background: #0a0908;
            border-radius: 2px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse;
        }

        /* LED fill that animates */
        .led-meter-fill {
            width: 100%;
            height: 0%;
            background: linear-gradient(180deg,
                #ff2020 0%,
                #ff4040 5%,
                #ffaa00 15%,
                #ffcc00 25%,
                #44dd44 40%,
                #22cc22 100%
            );
            transition: height 0.05s linear;
            position: relative;
            border-radius: 1px;
        }

        /* LED segment lines overlay */
        .led-meter-segments {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                180deg,
                transparent 0px,
                transparent 4px,
                #0a0908 4px,
                #0a0908 5px
            );
            pointer-events: none;
            z-index: 2;
        }

        /* Peak/Clip LED */
        .peak-led {
            position: absolute;
            top: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 6px;
            background: #330808;
            border-radius: 2px;
            border: 1px solid #4a3030;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
        }

        .peak-led.active {
            background: #ff0000;
            box-shadow:
                inset 0 1px 2px rgba(255,255,255,0.3),
                0 0 8px #ff0000,
                0 0 15px rgba(255, 0, 0, 0.5);
        }

        /* Scale markings next to meter */
        .led-meter-scale {
            position: absolute;
            left: -14px;
            top: 3px;
            bottom: 3px;
            width: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 0.35rem;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            color: #6a625a;
        }

        .led-meter-scale span {
            line-height: 1;
        }

        /* VU Meter - Takes top half of channel */
        .vu-meter {
            width: calc(100% - 8px);
            height: 90px;
            margin: 0 auto 0.75rem;
            background: linear-gradient(180deg, #1a1816 0%, #0d0c0a 100%);
            border-radius: 6px;
            border: 2px solid #3d352d;
            position: relative;
            box-shadow:
                inset 0 2px 8px rgba(0,0,0,0.8),
                0 2px 4px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Warm amber backlight glow */
        .vu-meter::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at 50% 100%, rgba(255, 180, 100, 0.15) 0%, transparent 60%);
            pointer-events: none;
            z-index: 1;
        }

        /* Cream colored face */
        .vu-face {
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            bottom: 6px;
            background: linear-gradient(180deg, #f5edd8 0%, #e8dfc8 50%, #ddd4bd 100%);
            border-radius: 4px 4px 2px 2px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.08);
        }

        /* Scale markings */
        .vu-scale {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            height: 24px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
        }

        /* Black numbers (left side) */
        .vu-scale::before {
            content: '-20  -10  -5  -3  0';
            position: absolute;
            top: 0;
            left: 0;
            font-size: 0.45rem;
            color: #1a1a1a;
            letter-spacing: 0.5px;
        }

        /* Red numbers (right side) */
        .vu-scale::after {
            content: '+3';
            position: absolute;
            top: 0;
            right: 4px;
            font-size: 0.45rem;
            color: #cc2020;
            font-weight: 800;
        }

        /* Red zone indicator */
        .vu-red-zone {
            position: absolute;
            top: 12px;
            right: 5px;
            width: 22%;
            height: 16px;
            background: linear-gradient(90deg, transparent 0%, rgba(204, 32, 32, 0.15) 50%, rgba(204, 32, 32, 0.3) 100%);
            border-radius: 0 6px 0 0;
        }

        /* VU label */
        .vu-label {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.5rem;
            font-weight: 700;
            color: #1a1a1a;
            letter-spacing: 2px;
        }

        /* The needle */
        .vu-needle {
            position: absolute;
            bottom: 8px;
            left: 50%;
            width: 2px;
            height: 55px;
            background: linear-gradient(180deg,
                #ff3030 0%,
                #cc2020 60%,
                #991515 100%
            );
            transform-origin: bottom center;
            transform: rotate(-45deg);
            transition: transform 0.12s ease-out;
            border-radius: 1px 1px 0 0;
            z-index: 5;
            box-shadow: 0 0 6px rgba(255, 50, 50, 0.5);
        }

        /* Needle pivot */
        .vu-needle::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 10px;
            background: radial-gradient(circle at 35% 35%, #5a5a5a 0%, #2a2a2a 50%, #1a1a1a 100%);
            border-radius: 50%;
            border: 1px solid #3a3a3a;
        }

        /* Glow when active */
        .vu-meter.lit .vu-face {
            background: linear-gradient(180deg, #fff8e8 0%, #f5ead0 50%, #e8dfc0 100%);
            box-shadow: inset 0 0 20px rgba(255, 200, 100, 0.2);
        }

        .stem-card.muted .vu-needle {
            transform: rotate(-45deg) !important;
            opacity: 0.4;
        }

        .stem-card.muted .vu-face {
            filter: brightness(0.6);
        }

        /* Fader section with LED beside it */
        .fader-section {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: stretch;
        }

        /* Mixer Controls - Vintage Buttons */
        .stem-mixer-controls {
            display: flex;
            justify-content: center;
            gap: 0.4rem;
            margin-bottom: 0.75rem;
        }

        .mute-btn, .solo-btn {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: 2px solid #3d352d;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.6rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow:
                0 3px 0 #2a2520,
                0 4px 8px rgba(0,0,0,0.3);
            position: relative;
            top: 0;
        }

        .mute-btn:active, .solo-btn:active {
            top: 2px;
            box-shadow:
                0 1px 0 #2a2520,
                0 2px 4px rgba(0,0,0,0.2);
        }

        .mute-btn {
            background: linear-gradient(180deg, #6b6560 0%, #4a4540 100%);
            color: #c4beb4;
        }

        .mute-btn.active {
            background: linear-gradient(180deg, #c41e3a 0%, #8b1528 100%);
            color: white;
            box-shadow:
                0 3px 0 #5a0d18,
                0 4px 8px rgba(0,0,0,0.3),
                0 0 12px rgba(196, 30, 58, 0.5);
        }

        .solo-btn {
            background: linear-gradient(180deg, #6b6560 0%, #4a4540 100%);
            color: #c4beb4;
        }

        .solo-btn.active {
            background: linear-gradient(180deg, #e5c07b 0%, #c9a555 100%);
            color: #2a2520;
            box-shadow:
                0 3px 0 #8a7030,
                0 4px 8px rgba(0,0,0,0.3),
                0 0 12px rgba(229, 192, 123, 0.5);
        }

        /* Vertical Fader Track */
        .stem-volume {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
        }

        .fader-track {
            width: 20px;
            height: 120px;
            background: linear-gradient(180deg, #1a1612 0%, #2a2520 100%);
            border-radius: 4px;
            border: 2px solid #3d352d;
            position: relative;
            box-shadow:
                inset 0 2px 8px rgba(0,0,0,0.8),
                0 2px 4px rgba(0,0,0,0.2);
        }

        /* Fader scale markings */
        .fader-track::before {
            content: '';
            position: absolute;
            top: 10px;
            bottom: 10px;
            left: -8px;
            width: 6px;
            background: repeating-linear-gradient(
                180deg,
                #8a8278 0px,
                #8a8278 1px,
                transparent 1px,
                transparent 12px
            );
        }

        /* Fader groove */
        .fader-groove {
            position: absolute;
            top: 8px;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            background: linear-gradient(180deg, #0d0c0a 0%, #1a1612 100%);
            border-radius: 2px;
        }

        /* The Fader Cap */
        .fader-cap {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 24px;
            background: linear-gradient(180deg,
                #e8e2d6 0%,
                #c4beb4 20%,
                #a8a298 50%,
                #c4beb4 80%,
                #e8e2d6 100%
            );
            border-radius: 3px;
            border: 1px solid #8a8278;
            cursor: grab;
            box-shadow:
                0 2px 4px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.5);
            transition: top 0.05s linear;
        }

        .fader-cap::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 4px;
            right: 4px;
            height: 1px;
            background: #6b5a48;
            box-shadow: 0 2px 0 #6b5a48;
        }

        .fader-cap:active {
            cursor: grabbing;
        }

        /* Hidden actual slider */
        .stem-volume-slider {
            position: absolute;
            width: 120px;
            height: 20px;
            transform: rotate(-90deg);
            transform-origin: center;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        /* Stem Actions */
        .stem-actions {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            margin-top: 0.5rem;
        }

        .stem-btn {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.6rem;
            font-weight: 600;
            padding: 0.4rem 0.5rem;
            background: linear-gradient(180deg, #4a4540 0%, #3d352d 100%);
            border: 1px solid #5a524a;
            border-radius: 4px;
            color: #c4beb4;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            display: block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .stem-btn:hover {
            background: linear-gradient(180deg, #ff7b54 0%, #e56a45 100%);
            border-color: #ff7b54;
            color: white;
        }

        .stem-btn.midi {
            background: linear-gradient(180deg, #2a4a5a 0%, #1a3a4a 100%);
            border-color: #3a5a6a;
            color: #7ab8d4;
        }

        .stem-btn.midi:hover {
            background: linear-gradient(180deg, #56b6c2 0%, #3a9aa8 100%);
            border-color: #56b6c2;
            color: #1a1612;
        }

        .stem-btn.notation {
            background: linear-gradient(180deg, #5a3a6a 0%, #4a2a5a 100%);
            border-color: #7a5a8a;
            color: #d4a8e4;
        }

        .stem-btn.notation:hover {
            background: linear-gradient(180deg, #c678dd 0%, #a858c8 100%);
            border-color: #c678dd;
            color: white;
        }

        .stem-btn.enhanced {
            background: linear-gradient(180deg, #2a5a3a 0%, #1a4a2a 100%);
            border-color: #3a7a4a;
            color: #98c379;
        }

        .stem-btn.enhanced:hover {
            background: linear-gradient(180deg, #98c379 0%, #78a359 100%);
            border-color: #98c379;
            color: #1a1612;
        }

        .stem-btn.raw {
            background: linear-gradient(180deg, #4a4a3a 0%, #3a3a2a 100%);
            border-color: #5a5a4a;
            color: #a8a888;
            font-size: 0.6rem;
        }

        .stem-btn.raw:hover {
            background: linear-gradient(180deg, #6a6a5a 0%, #5a5a4a 100%);
            border-color: #7a7a6a;
            color: white;
        }

        .stem-audio {
            display: none;
        }

        /* Practice Mode CTA */
        .practice-cta {
            text-align: center;
            margin-top: 3rem;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(198, 120, 221, 0.1) 0%, rgba(97, 175, 239, 0.1) 100%);
            border: 1px solid rgba(198, 120, 221, 0.2);
            border-radius: 20px;
        }

        .practice-btn {
            font-family: 'Righteous', cursive;
            font-size: 1.1rem;
            letter-spacing: 1px;
            padding: 1rem 2.5rem;
            background: linear-gradient(135deg, var(--psych-purple), var(--psych-blue));
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
        }

        .practice-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(198, 120, 221, 0.3);
        }

        /* Footer */
        .footer {
            position: relative;
            z-index: 1;
            text-align: center;
            padding: 3rem 2rem;
            border-top: 1px solid rgba(255,255,255,0.05);
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
        }

        .footer-links a {
            color: var(--text-dim);
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: var(--psych-orange);
        }

        /* Settings Panel */
        .settings-btn {
            background: var(--bg-card);
            border: 1px solid var(--psych-purple);
            color: var(--psych-purple);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .settings-btn:hover {
            background: rgba(198, 120, 221, 0.1);
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--psych-purple);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
            box-shadow: -10px 0 40px rgba(0,0,0,0.5);
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .settings-header h3 {
            font-family: 'Righteous', cursive;
            color: var(--psych-purple);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .close-settings {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .settings-section {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .settings-section h4 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 1rem;
        }

        .status-card {
            background: var(--bg-dark);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .status-row:last-child {
            margin-bottom: 0;
        }

        .status-label {
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        .status-value {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-value.connected {
            color: var(--psych-green);
        }

        .status-value.disconnected {
            color: #e74c3c;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.green {
            background: var(--psych-green);
            box-shadow: 0 0 8px var(--psych-green);
        }

        .status-dot.red {
            background: #e74c3c;
            box-shadow: 0 0 8px #e74c3c;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Toggle Switch */
        .toggle-setting {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .toggle-setting:last-child {
            border-bottom: none;
        }

        .toggle-label {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .toggle-label .title {
            font-size: 0.9rem;
            color: var(--text-main);
        }

        .toggle-label .desc {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(60, 60, 80, 0.8);
            border-radius: 26px;
            transition: 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .toggle-slider::before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background: linear-gradient(180deg, #888 0%, #666 100%);
            border-radius: 50%;
            transition: 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(90deg, var(--psych-orange), var(--psych-pink));
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(24px);
            background: linear-gradient(180deg, #fff 0%, #ddd 100%);
        }

        .toggle-options {
            display: flex;
            gap: 0.5rem;
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 0.25rem;
        }

        .toggle-options span {
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .toggle-options span.active {
            background: rgba(255,123,84,0.2);
            color: var(--psych-orange);
        }

        .settings-btn-action {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
        }

        .settings-btn-action.primary {
            background: linear-gradient(135deg, var(--psych-purple), var(--psych-blue));
            color: white;
        }

        .settings-btn-action.secondary {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .settings-btn-action:hover {
            transform: translateY(-1px);
        }

        .settings-btn-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .disk-usage {
            margin-top: 1rem;
        }

        .disk-bar {
            height: 8px;
            background: var(--bg-deep);
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .disk-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--psych-green), var(--psych-yellow));
            border-radius: 4px;
            transition: width 0.5s;
        }

        .disk-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Estimated Time Display */
        .eta-display {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .eta-display .eta-time {
            color: var(--psych-yellow);
            font-weight: 600;
        }

        /* Settings overlay */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .settings-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        /* Library Panel */
        .library-btn {
            background: var(--bg-card);
            border: 1px solid var(--psych-orange);
            color: var(--psych-orange);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .library-btn:hover {
            background: rgba(255, 170, 100, 0.1);
        }

        .library-panel {
            position: fixed;
            top: 0;
            left: -450px;
            width: 420px;
            height: 100vh;
            background: var(--bg-card);
            border-right: 1px solid var(--psych-orange);
            z-index: 1000;
            transition: left 0.3s ease;
            overflow-y: auto;
            box-shadow: 10px 0 40px rgba(0,0,0,0.5);
        }

        .library-panel.open {
            left: 0;
        }

        .library-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background: var(--bg-card);
        }

        .library-header h3 {
            font-family: 'Righteous', cursive;
            color: var(--psych-orange);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .close-library {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .library-content {
            padding: 1rem;
        }

        .library-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .library-loading, .library-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-dim);
        }

        .library-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .library-item:hover {
            border-color: var(--psych-orange);
            background: rgba(255, 170, 100, 0.05);
        }

        .library-item-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .library-item-thumb {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
            background: var(--bg-dark);
        }

        .library-item-info {
            flex: 1;
            min-width: 0;
        }

        .library-item-title {
            font-weight: 600;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.95rem;
        }

        .library-item-artist {
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        .library-item-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .library-item-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .library-item-delete {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            opacity: 0;
            transition: all 0.2s;
        }

        .library-item:hover .library-item-delete {
            opacity: 1;
        }

        .library-item-delete:hover {
            color: #f55;
            background: rgba(255, 85, 85, 0.1);
        }

        .library-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .library-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--psych-green);
            padding: 1rem 2rem;
            border-radius: 10px;
            color: var(--text);
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.error {
            border-color: #e74c3c;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }

            .header {
                padding: 1rem 1.5rem;
            }

            .nav-links {
                display: none;
            }

            .container {
                padding: 2rem 1rem;
            }

            .stems-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="psych-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <header class="header">
        <div class="logo">
            <span class="logo-symbol">✦</span>
            <span class="logo-text">StemScribe</span>
        </div>
        <nav class="nav-links">
            <a href="#">How It Works</a>
            <a href="practice.html">Practice Mode</a>
            <button class="library-btn" id="libraryBtn">📚 Library</button>
            <button class="settings-btn" id="settingsBtn">⚙️ Settings</button>
        </nav>
    </header>

    <!-- Settings Panel -->
    <div class="settings-overlay" id="settingsOverlay"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h3>⚙️ Settings</h3>
            <button class="close-settings" id="closeSettings">×</button>
        </div>

        <!-- Google Drive Section -->
        <div class="settings-section">
            <h4>☁️ Google Drive</h4>
            <div class="status-card">
                <div class="status-row">
                    <span class="status-label">Connection</span>
                    <span class="status-value" id="driveStatus">
                        <span class="status-indicator">
                            <span class="status-dot red" id="driveDot"></span>
                            <span id="driveStatusText">Checking...</span>
                        </span>
                    </span>
                </div>
                <div class="status-row" id="driveStatsRow" style="display: none;">
                    <span class="status-label">Saved Transcriptions</span>
                    <span class="status-value" id="driveFileCount">0 songs</span>
                </div>
            </div>
            <button class="settings-btn-action primary" id="connectDriveBtn">
                🔗 Connect Google Drive
            </button>
            <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.5rem;">
                Auto-saves MIDI & notation to your Drive after processing
            </p>
        </div>

        <!-- Local Storage Section -->
        <div class="settings-section">
            <h4>💾 Local Storage</h4>
            <div class="status-card">
                <div class="status-row">
                    <span class="status-label">Jobs on Disk</span>
                    <span class="status-value" id="localJobCount">-</span>
                </div>
                <div class="disk-usage">
                    <div class="disk-bar">
                        <div class="disk-fill" id="diskFill" style="width: 0%"></div>
                    </div>
                    <div class="disk-stats">
                        <span id="diskUsed">Calculating...</span>
                        <span id="diskTotal"></span>
                    </div>
                </div>
            </div>
            <button class="settings-btn-action secondary" id="cleanupBtn">
                🧹 Clean Up Old Stems (7+ days)
            </button>
            <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.5rem;">
                Keeps MIDI & notation, removes large audio stems
            </p>
        </div>

        <!-- Mixer Display Section -->
        <div class="settings-section">
            <h4>🎚️ Mixer Display</h4>
            <div class="toggle-setting">
                <div class="toggle-label">
                    <span class="title">Sub-Stem Layout</span>
                    <span class="desc">How skill-enhanced stems appear in mixer</span>
                    <div class="toggle-options">
                        <span id="optionA" class="active">A: Dynamic (flat)</span>
                        <span id="optionB">B: Hierarchical (nested)</span>
                    </div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="mixerLayoutToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="status-card" style="margin-top: 1rem; padding: 0.75rem;">
                <div style="font-size: 0.75rem; color: var(--text-dim);">
                    <strong style="color: var(--text-main);">A: Dynamic</strong> — All stems in one row, sub-stems appear as additional channels<br><br>
                    <strong style="color: var(--text-main);">B: Hierarchical</strong> — Sub-stems nested under parent stem with expand/collapse
                </div>
            </div>
        </div>

        <!-- Audio Processing Settings -->
        <div class="settings-section">
            <h4>🎤 Audio Processing</h4>
            <div class="status-card" style="padding: 0.75rem;">
                <div style="font-size: 0.75rem; color: var(--text-dim);">
                    <strong style="color: var(--neon-green);">🧠 Smart Mode:</strong> StemScribe automatically detects complexity and extracts every instrument. Dense mixes get deep extraction — simple tracks finish fast.<br><br>
                    <strong style="color: var(--text-main);">One button, best result every time.</strong> No configuration needed.
                </div>
            </div>

            <!-- Notation Options -->
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <h5 style="margin: 0 0 0.75rem 0; color: var(--psych-blue);">📝 Notation Options</h5>
            </div>

            <div class="toggle-setting">
                <div class="toggle-label">
                    <span class="title">🎸 Guitar Pro Tabs</span>
                    <span class="desc">Generate .gp5 files with real tablature (+2-3 min)</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="gpTabsToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="toggle-setting" style="margin-top: 1rem;">
                <div class="toggle-label">
                    <span class="title">🎵 Chord Detection</span>
                    <span class="desc">Analyze chord progressions and key (+1-2 min)</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="chordDetectionToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="status-card" style="margin-top: 0.5rem; padding: 0.75rem;">
                <div style="font-size: 0.75rem; color: var(--text-dim);">
                    <strong style="color: var(--psych-green);">💡 Quick Mode:</strong> Disable these options for faster processing (~5-7 min total).<br>
                    You'll still get stems, MIDI, and standard notation.
                </div>
            </div>
        </div>

        <!-- Processing Info -->
        <div class="settings-section">
            <h4>⏱️ Processing Times</h4>
            <div class="status-card">
                <div class="status-row">
                    <span class="status-label">Stem Separation</span>
                    <span class="status-value">~3-5 min</span>
                </div>
                <div class="status-row">
                    <span class="status-label">MIDI Transcription</span>
                    <span class="status-value">~6-12 min</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Total (typical)</span>
                    <span class="status-value" style="color: var(--psych-yellow);">~10-15 min</span>
                </div>
            </div>
            <p style="font-size: 0.75rem; color: var(--text-dim);">
                Processing runs locally on your Mac using AI models. Longer songs take more time.
            </p>
        </div>
    </div>

    <!-- Library Panel -->
    <div class="library-overlay" id="libraryOverlay"></div>
    <div class="library-panel" id="libraryPanel">
        <div class="library-header">
            <h3>📚 Your Library</h3>
            <button class="close-library" id="closeLibrary">×</button>
        </div>
        <div class="library-content">
            <div class="library-list" id="libraryList">
                <div class="library-loading">Loading library...</div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastIcon">✓</span>
        <span id="toastMessage">Success!</span>
    </div>

    <div class="container">
        <section class="hero">
            <span class="hero-label">✦ Stem Separation & Transcription</span>
            <h1>Tear The <span class="highlight">Sound</span> Apart</h1>
            <p>Drop any track and watch it split into pristine stems. Get tabs, sheet music, and practice tools. Learn from the masters.</p>
        </section>

        <section class="upload-section" id="uploadSection">
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="file">
                    <span>📁</span> Upload File
                </button>
                <button class="mode-btn" data-mode="url">
                    <span>🔗</span> Paste Link
                </button>
                <button class="mode-btn" data-mode="archive">
                    <span>🎤</span> Live Music
                </button>
            </div>

            <div class="drop-zone" id="dropZone">
                <div class="drop-icon">🎧</div>
                <div class="drop-title">Drop your track here</div>
                <div class="drop-subtitle">MP3, WAV, FLAC, M4A, OGG • Up to 500MB</div>
                <input type="file" class="file-input" id="fileInput" accept=".mp3,.wav,.flac,.m4a,.ogg,.aiff,.webm,.opus">
            </div>

            <div class="url-section" id="urlSection">
                <div class="url-input-wrapper">
                    <input type="text" class="url-input" id="urlInput" placeholder="Paste a Spotify, Apple Music, YouTube, SoundCloud, or Archive.org link...">
                </div>
                <div class="platforms">
                    <span class="platform-pill" style="border-color: #1DB954; color: #1DB954;">🎧 Spotify</span>
                    <span class="platform-pill" style="border-color: #fc3c44; color: #fc3c44;">🍎 Apple Music</span>
                    <span class="platform-pill">▶️ YouTube</span>
                    <span class="platform-pill">☁️ SoundCloud</span>
                    <span class="platform-pill">🎵 Bandcamp</span>
                    <span class="platform-pill clickable" style="border-color: var(--psych-teal); color: var(--psych-teal);" onclick="document.querySelector('[data-mode=archive]').click()">🎤 Archive.org</span>
                </div>
            </div>

            <!-- Archive.org Live Music Browser -->
            <div class="archive-section" id="archiveSection">
                <div id="archiveSearchView">
                    <div class="archive-search-wrapper">
                        <input type="text" class="archive-search" id="archiveSearchInput"
                               placeholder="Search live recordings... (e.g., Grateful Dead 1977, Phish, Allman Brothers)">
                        <button class="archive-search-btn" id="archiveSearchBtn">Search</button>
                    </div>
                    <div class="archive-filters">
                        <input type="text" class="archive-year-input" id="archiveYearInput" placeholder="Year" maxlength="4">
                        <span class="archive-filter" data-collection="GratefulDead">🌹 Dead</span>
                        <span class="archive-filter" data-collection="Phish">🐟 Phish</span>
                        <span class="archive-filter" data-collection="UmphreysMcGee">🎸 Umphrey's</span>
                        <span class="archive-filter" data-collection="WidespreadPanic">🌊 Panic</span>
                        <span class="archive-filter" data-collection="StringCheeseIncident">🧀 SCI</span>
                        <span class="archive-filter" data-collection="etree">🌲 All Bands</span>
                    </div>
                    <div id="archiveResults" class="archive-results">
                        <div class="archive-empty">
                            Search 250,000+ free concert recordings from the Internet Archive
                        </div>
                    </div>
                </div>

                <div id="archiveShowView" style="display: none;">
                    <button class="archive-back-btn" id="archiveBackBtn">← Back to results</button>
                    <div id="archiveShowDetails"></div>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="submit-btn" id="submitBtn" disabled>✦ Separate Stems ✦</button>
            </div>
        </section>

        <section class="processing-section" id="processingSection">
            <div class="vinyl-spinner">
                <div class="vinyl"></div>
                <div class="vinyl-label">🎵</div>
            </div>
            <div class="stage-text" id="stageText">Separating stems with AI (6-stem model)</div>
            <div class="progress-container">
                <!-- City Skyline - Cross Country Tour -->
                <div class="city-skyline">
                    <!-- San Francisco - Golden Gate Bridge -->
                    <div class="city city-sf visited" id="city-sf">
                        <div class="city-name">SF</div>
                        <div class="skyline">
                            <svg viewBox="0 0 140 70" class="gg-bridge">
                                <!-- Bay water -->
                                <rect class="water" x="0" y="55" width="140" height="15"/>

                                <!-- Fog -->
                                <ellipse class="fog" cx="70" cy="57" rx="55" ry="3"/>

                                <!-- Road deck - BELOW cables, passes through towers -->
                                <rect class="deck" x="0" y="42" width="140" height="4"/>
                                <line class="guardrail" x1="0" y1="41" x2="140" y2="41"/>
                                <line class="guardrail" x1="0" y1="46" x2="140" y2="46"/>
                                <line class="road-line" x1="5" y1="44" x2="135" y2="44" stroke-dasharray="4 3"/>

                                <!-- Left Tower -->
                                <g class="tower tower-left">
                                    <rect x="28" y="4" width="4" height="54"/>
                                    <rect x="36" y="4" width="4" height="54"/>
                                    <rect class="brace" x="28" y="12" width="12" height="2"/>
                                    <rect class="brace" x="28" y="24" width="12" height="2"/>
                                    <rect class="brace" x="28" y="36" width="12" height="2"/>
                                    <rect class="cap" x="26" y="2" width="16" height="4" rx="0.5"/>
                                    <rect class="cap" x="29" y="0" width="10" height="3" rx="0.5"/>
                                </g>

                                <!-- Right Tower -->
                                <g class="tower tower-right">
                                    <rect x="100" y="4" width="4" height="54"/>
                                    <rect x="108" y="4" width="4" height="54"/>
                                    <rect class="brace" x="100" y="12" width="12" height="2"/>
                                    <rect class="brace" x="100" y="24" width="12" height="2"/>
                                    <rect class="brace" x="100" y="36" width="12" height="2"/>
                                    <rect class="cap" x="98" y="2" width="16" height="4" rx="0.5"/>
                                    <rect class="cap" x="101" y="0" width="10" height="3" rx="0.5"/>
                                </g>

                                <!-- Main cables - connect at tower tops, sag to y=28 (well above deck at y=42) -->
                                <path class="main-cable" d="M0 16 Q15 10, 34 4" fill="none"/>
                                <path class="main-cable" d="M34 4 Q70 28, 106 4" fill="none"/>
                                <path class="main-cable" d="M106 4 Q125 10, 140 16" fill="none"/>

                                <!-- Suspender cables - from cable down to deck -->
                                <g class="suspenders">
                                    <line x1="12" y1="13" x2="12" y2="42"/>
                                    <line x1="22" y1="8" x2="22" y2="42"/>
                                    <line x1="44" y1="8" x2="44" y2="42"/>
                                    <line x1="52" y1="12" x2="52" y2="42"/>
                                    <line x1="60" y1="18" x2="60" y2="42"/>
                                    <line x1="70" y1="24" x2="70" y2="42"/>
                                    <line x1="80" y1="18" x2="80" y2="42"/>
                                    <line x1="88" y1="12" x2="88" y2="42"/>
                                    <line x1="96" y1="8" x2="96" y2="42"/>
                                    <line x1="118" y1="8" x2="118" y2="42"/>
                                    <line x1="128" y1="13" x2="128" y2="42"/>
                                </g>
                            </svg>
                        </div>
                    </div>
                    <!-- Denver - Rocky Mountains -->
                    <div class="city city-denver" id="city-denver">
                        <div class="city-name">Denver</div>
                        <div class="skyline">
                            <svg viewBox="0 0 110 60" class="rockies">
                                <!-- Back range (distant, faded) -->
                                <path class="mountain-back" d="M0 60 L15 35 L25 42 L40 22 L55 38 L70 28 L85 40 L100 32 L110 45 L110 60 Z"/>

                                <!-- Middle range -->
                                <path class="mountain-mid" d="M-5 60 L12 40 L22 48 L35 25 L48 42 L58 32 L75 45 L90 35 L105 48 L115 60 Z"/>

                                <!-- Front range (main peaks) -->
                                <path class="mountain-front" d="M-10 60 L8 45 L18 52 L28 30 L38 42 L55 15 L72 42 L82 30 L95 50 L105 42 L120 60 Z"/>

                                <!-- Snow caps -->
                                <path class="snow" d="M28 30 L35 38 L38 42 L55 15 L72 42 L69 38 L55 22 Z"/>
                                <path class="snow-small" d="M82 30 L88 38 L82 35 Z"/>

                                <!-- Pine tree forest -->
                                <path class="trees" d="M0 60 L5 52 L8 56 L12 48 L16 54 L20 46 L24 52 L28 44 L32 50 L36 42 L40 48 L44 40 L48 46 L52 38 L56 44 L60 36 L64 42 L68 34 L72 40 L76 32 L80 38 L84 30 L88 36 L92 42 L96 48 L100 44 L104 50 L108 46 L110 60 Z"/>

                                <!-- Ground -->
                                <rect class="ground" x="0" y="56" width="110" height="4"/>
                            </svg>
                        </div>
                    </div>
                    <!-- Chicago - Willis Tower Skyline -->
                    <div class="city city-chicago" id="city-chicago">
                        <div class="city-name">Chicago</div>
                        <div class="skyline">
                            <svg viewBox="0 0 100 70" class="chi-skyline">
                                <!-- Lake Michigan reflection area -->
                                <rect class="lake" x="0" y="58" width="100" height="12" rx="2"/>

                                <!-- Building 1 - small left -->
                                <rect class="building b1" x="5" y="38" width="8" height="20" rx="1"/>

                                <!-- Building 2 - medium -->
                                <rect class="building b2" x="15" y="28" width="10" height="30" rx="1"/>

                                <!-- Hancock Center (X-braced) -->
                                <g class="hancock">
                                    <path class="building" d="M27 58 L30 12 L40 12 L43 58 Z"/>
                                    <!-- X-bracing -->
                                    <line class="x-brace" x1="28" y1="20" x2="42" y2="45"/>
                                    <line class="x-brace" x1="42" y1="20" x2="28" y2="45"/>
                                    <line class="x-brace" x1="29" y1="45" x2="41" y2="58"/>
                                    <line class="x-brace" x1="41" y1="45" x2="29" y2="58"/>
                                    <!-- Antenna -->
                                    <line class="antenna" x1="35" y1="12" x2="35" y2="2"/>
                                    <circle class="beacon" cx="35" cy="2" r="2"/>
                                </g>

                                <!-- Willis/Sears Tower (stepped top) -->
                                <g class="willis">
                                    <path class="building" d="M48 58 L48 18 L52 18 L52 12 L58 12 L58 8 L62 8 L62 12 L68 12 L68 18 L72 18 L72 58 Z"/>
                                    <!-- Twin antennas -->
                                    <line class="antenna" x1="56" y1="8" x2="56" y2="-2"/>
                                    <line class="antenna" x1="64" y1="8" x2="64" y2="-2"/>
                                    <circle class="beacon left-beacon" cx="56" cy="-2" r="2"/>
                                    <circle class="beacon right-beacon" cx="64" cy="-2" r="2"/>
                                    <!-- Window grid -->
                                    <line class="window-line" x1="50" y1="25" x2="70" y2="25"/>
                                    <line class="window-line" x1="50" y1="35" x2="70" y2="35"/>
                                    <line class="window-line" x1="50" y1="45" x2="70" y2="45"/>
                                </g>

                                <!-- Aon Center -->
                                <rect class="building aon" x="76" y="22" width="10" height="36" rx="1"/>

                                <!-- Small right building -->
                                <rect class="building b5" x="88" y="35" width="8" height="23" rx="1"/>
                            </svg>
                        </div>
                    </div>
                    <!-- NYC - Empire State & Chrysler -->
                    <div class="city city-nyc" id="city-nyc">
                        <div class="city-name">NYC</div>
                        <div class="skyline">
                            <div class="building b1"></div>
                            <div class="building b2"></div>
                            <div class="building empire"></div>
                            <div class="building chrysler"></div>
                            <div class="building owtc"></div>
                            <div class="building b5"></div>
                            <!-- King Kong! -->
                            <div class="king-kong">
                                <div class="kong-head"></div>
                                <div class="kong-body"></div>
                                <div class="kong-arm left"></div>
                                <div class="kong-arm right"></div>
                            </div>
                            <!-- Biplane buzzing around -->
                            <div class="biplane">
                                <div class="plane-tail"></div>
                                <div class="plane-body"></div>
                                <div class="plane-wings"></div>
                                <div class="plane-prop"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="progress-road">
                    <div class="bus-trail" id="busTrail" style="width: 0%"></div>
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    <div class="tour-bus" id="tourBus">
                        <!-- Rooftop with AC units -->
                        <div class="bus-roof"></div>
                        <!-- LED Destination Sign -->
                        <div class="bus-sign">ON TOUR</div>
                        <div class="bus-body">
                            <!-- Custom band wrap artwork -->
                            <div class="bus-wrap"></div>
                            <!-- Running lights along bottom -->
                            <div class="bus-running-lights">
                                <div class="running-light"></div>
                                <div class="running-light"></div>
                                <div class="running-light"></div>
                                <div class="running-light"></div>
                                <div class="running-light"></div>
                                <div class="running-light"></div>
                                <div class="running-light"></div>
                            </div>
                            <div class="bus-windows">
                                <div class="bus-window">
                                    <div class="bus-person p1">
                                        <div class="head"></div>
                                        <div class="body"></div>
                                    </div>
                                </div>
                                <div class="bus-window">
                                    <div class="bus-person p2">
                                        <div class="head"></div>
                                        <div class="body"></div>
                                    </div>
                                </div>
                                <div class="bus-window">
                                    <div class="bus-person p3">
                                        <div class="head"></div>
                                        <div class="body"></div>
                                    </div>
                                </div>
                                <div class="bus-window">
                                    <div class="bus-person p4">
                                        <div class="head"></div>
                                        <div class="body"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bus-front"></div>
                        <div class="bus-mirror"></div>
                        <div class="bus-wheel front"></div>
                        <div class="bus-wheel back"></div>
                        <div class="bus-mud-flap front"></div>
                        <div class="bus-mud-flap back"></div>
                        <div class="bus-exhaust">
                            <div class="smoke-puff"></div>
                            <div class="smoke-puff"></div>
                            <div class="smoke-puff"></div>
                        </div>
                    </div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
                <div class="progress-label">The Tour Bus is rollin'...</div>
            </div>
            <div class="stage-subtitle">This might take a few minutes. The AI is doing its thing.</div>
        </section>

        <section class="results-section" id="resultsSection">
            <div class="results-header">
                <h2>✦ <span>Stems Ready</span> ✦</h2>
                <p style="color: var(--text-dim);">Mix, mute, and solo your stems. Click a stem to toggle it.</p>
            </div>

            <div class="song-card" id="songCard" style="display: none;">
                <img class="song-thumb" id="songThumb" src="" alt="">
                <div class="song-details">
                    <h3 id="songTitle">Song Title</h3>
                    <p id="songArtist">Artist</p>
                </div>
                <button class="info-toggle-btn" id="infoToggleBtn" onclick="toggleTrackInfo()" title="Show track info">
                    ℹ️
                </button>
            </div>

            <!-- Track Info Panel -->
            <div class="track-info-panel" id="trackInfoPanel" style="display: none;">
                <div class="info-header">
                    <h3>📖 About This Track</h3>
                    <button class="info-close-btn" onclick="toggleTrackInfo()">✕</button>
                </div>
                <div class="info-content">
                    <div class="info-loading" id="infoLoading">
                        <div class="info-spinner"></div>
                        <span>Fetching track info...</span>
                    </div>
                    <div class="info-body" id="infoBody" style="display: none;">
                        <div class="info-section" id="albumSection" style="display: none;">
                            <h4>💿 Album</h4>
                            <div class="album-info">
                                <span class="album-name" id="albumName"></span>
                                <span class="album-year" id="albumYear"></span>
                            </div>
                            <p id="albumDescription" class="album-desc"></p>
                        </div>
                        <div class="info-section" id="eraSection" style="display: none;">
                            <h4>📅 Era</h4>
                            <div class="era-info">
                                <span class="era-keyboardist" id="eraKeyboardist"></span>
                                <span class="era-years" id="eraYears"></span>
                            </div>
                            <p id="eraNotes" class="era-notes"></p>
                        </div>
                        <div class="info-section" id="artistBioSection">
                            <h4>🎸 Artist</h4>
                            <p id="artistBio"></p>
                            <a id="wikiLink" href="#" target="_blank" style="display: none;">Read more on Wikipedia →</a>
                        </div>
                        <div class="info-section" id="songInfoSection" style="display: none;">
                            <h4>🎵 About the Song</h4>
                            <p id="songInfo"></p>
                            <a id="songWikiLink" href="#" target="_blank" style="display: none; color: var(--psych-blue); text-decoration: none; font-size: 0.9em;">Read more on Wikipedia →</a>
                            <a id="geniusLink" href="#" target="_blank" style="display: none; color: #ffff64; text-decoration: none; font-size: 0.9em; margin-left: 8px;">Lyrics & Info on Genius →</a>
                        </div>
                        <div class="info-section" id="membersSection" style="display: none;">
                            <h4>👥 Band Members</h4>
                            <div id="membersList"></div>
                        </div>
                        <div class="info-section" id="personnelSection" style="display: none;">
                            <h4>🎭 Album Personnel</h4>
                            <div id="personnelList"></div>
                        </div>
                        <div class="info-section" id="learningTipsSection">
                            <h4>📚 Learning Tips</h4>
                            <p id="learningTips"></p>
                        </div>
                        <div class="info-section" id="stemTipsSection">
                            <h4>🎯 Stem-Specific Tips</h4>
                            <div id="stemTipsList"></div>
                        </div>
                        <div class="info-section" id="styleSection" style="display: none;">
                            <h4>🎨 Style</h4>
                            <p id="styleInfo"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Master Transport -->
            <div class="master-transport">
                <div class="transport-controls">
                    <button class="skip-btn" id="skipBackBtn" title="Back 10s">⏪</button>
                    <button class="play-btn" id="masterPlayBtn">▶</button>
                    <button class="skip-btn" id="skipForwardBtn" title="Forward 10s">⏩</button>
                    <div class="timeline-container">
                        <div class="timeline" id="timeline">
                            <div class="timeline-progress" id="timelineProgress"></div>
                            <div class="timeline-handle" id="timelineHandle" style="left: 0%"></div>
                        </div>
                        <div class="time-display">
                            <span id="currentTime">0:00</span>
                            <span id="totalTime">0:00</span>
                        </div>
                    </div>
                    <div class="master-volume">
                        <span>🔊</span>
                        <input type="range" class="volume-slider" id="masterVolume" min="0" max="100" value="80">
                    </div>
                </div>
            </div>

            <div class="stems-grid" id="stemsGrid"></div>

            <div class="practice-cta">
                <p style="margin-bottom: 1rem; color: var(--text-dim);">Ready to learn this track?</p>
                <button class="practice-btn" id="practiceBtn" onclick="openPracticeMode()">
                    🎯 Open Practice Mode
                </button>
            </div>
        </section>
    </div>

    <footer class="footer">
        <div class="footer-links">
            <a href="#">GitHub</a>
            <a href="#">Documentation</a>
            <a href="#">Support</a>
        </div>
        <p>Built with ♥ using Demucs • Basic Pitch • AlphaTab</p>
    </footer>

    <script>
        const API_BASE = 'http://localhost:5555/api';
        let currentMode = 'file';
        let selectedFile = null;
        let currentJobId = null;

        // Progress interpolation for smooth animations
        let displayedProgress = 0;
        let targetProgress = 0;
        let progressAnimationId = null;
        let lastProgressUpdate = Date.now();

        const stemConfig = {
            // Primary 6-stem separation
            vocals: { icon: '🎙️', color: '#ff6b9d', label: 'VOCALS' },
            drums: { icon: '🥁', color: '#e5c07b', label: 'DRUMS' },
            bass: { icon: '🔊', color: '#ff7b54', label: 'BASS' },
            guitar: { icon: '🎸', color: '#61afef', label: 'GUITAR' },
            piano: { icon: '🎹', color: '#98c379', label: 'KEYS' },
            other: { icon: '🎛️', color: '#c678dd', label: 'OTHER' },

            // Smart deep extraction stems (auto-named by smart_separate)
            backing_vocals: { icon: '🎤', color: '#ff85b3', label: 'BG VOCALS', extracted: true },
            vocals_lead: { icon: '🎙️', color: '#ff4070', label: 'LEAD VOX', extracted: true },
            vocals_backing: { icon: '🎤', color: '#ff85b3', label: 'BG VOCALS', extracted: true },
            guitar_2: { icon: '🎸', color: '#71bfff', label: 'GUITAR 2', extracted: true },
            keys_2: { icon: '🎹', color: '#a8d389', label: 'KEYS 2', extracted: true },
            bass_2: { icon: '🔊', color: '#ff9574', label: 'BASS 2', extracted: true },
            percussion_2: { icon: '🪘', color: '#f5d08b', label: 'PERC 2', extracted: true },
            other_deep: { icon: '🎷', color: '#d688ed', label: 'EXTRAS', extracted: true },

            // Legacy cascaded stems (backwards compatible)
            other_vocals: { icon: '🎤', color: '#ff85b3', label: 'BG VOCALS', extracted: true },
            other_drums: { icon: '🪘', color: '#f5d08b', label: 'PERCUSSION', extracted: true },
            other_bass: { icon: '🎵', color: '#ff9574', label: 'SUB BASS', extracted: true },
            other_guitar: { icon: '🪕', color: '#71bfff', label: 'STRINGS', extracted: true },
            other_piano: { icon: '🪗', color: '#a8d389', label: 'PADS', extracted: true },
            other_other: { icon: '🎷', color: '#d688ed', label: 'BRASS/FX', extracted: true },
        };

        // Sub-stem colors for skills output
        const subStemColors = {
            // Vocal Virtuoso - perfect for Steely Dan & CSNY harmonies!
            vocals_lead: '#ff6b9d',
            vocals_harmony: '#ff85b3',
            vocals_high: '#ffa5c3',
            vocals_low: '#e55b8d',
            // Horn Hunter
            horns: '#ffd700',
            other_no_horns: '#c678dd',
            // Guitar God
            guitar_lead: '#61afef',
            guitar_rhythm: '#5a9bd4',
            guitar_clean: '#98c379',
            guitar_distorted: '#e06c75',
            // String Section
            strings_high: '#d19a66',
            strings_low: '#c18a56',
            // Keys Kingdom
            keys_acoustic: '#98c379',
            keys_electric: '#61dafb',
            keys_synth: '#c678dd'
        };

        // Skills system - loaded for displaying sub-stems in results
        // Skills run automatically on backend - no user selection needed
        let availableSkills = [];

        async function loadSkills() {
            try {
                const res = await fetch(`${API_BASE}/skills`);
                const data = await res.json();
                if (data.available && data.skills.length > 0) {
                    availableSkills = data.skills;
                    console.log('Skills loaded:', availableSkills.map(s => s.name).join(', '));
                }
            } catch (e) {
                console.log('Skills info not available:', e);
            }
        }

        // DOM
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const urlInput = document.getElementById('urlInput');
        const urlSection = document.getElementById('urlSection');
        const submitBtn = document.getElementById('submitBtn');
        const uploadSection = document.getElementById('uploadSection');
        const processingSection = document.getElementById('processingSection');
        const resultsSection = document.getElementById('resultsSection');

        // Archive.org elements
        const archiveSection = document.getElementById('archiveSection');
        const archiveSearchInput = document.getElementById('archiveSearchInput');
        const archiveSearchBtn = document.getElementById('archiveSearchBtn');
        const archiveResults = document.getElementById('archiveResults');
        const archiveSearchView = document.getElementById('archiveSearchView');
        const archiveShowView = document.getElementById('archiveShowView');
        const archiveShowDetails = document.getElementById('archiveShowDetails');
        const archiveBackBtn = document.getElementById('archiveBackBtn');
        const archiveYearInput = document.getElementById('archiveYearInput');

        // Mode toggle
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
                dropZone.style.display = currentMode === 'file' ? 'block' : 'none';
                urlSection.classList.toggle('active', currentMode === 'url');
                archiveSection.classList.toggle('active', currentMode === 'archive');
                updateSubmitBtn();
            });
        });

        // Load skills on page load
        loadSkills();

        // =====================================================================
        // Archive.org Live Music Browser
        // =====================================================================

        let archiveSelectedCollection = null;

        // Collection filter buttons
        document.querySelectorAll('.archive-filter').forEach(btn => {
            btn.addEventListener('click', () => {
                const wasActive = btn.classList.contains('active');
                document.querySelectorAll('.archive-filter').forEach(b => b.classList.remove('active'));
                if (!wasActive) {
                    btn.classList.add('active');
                    archiveSelectedCollection = btn.dataset.collection;
                    // Auto-search with the collection
                    const query = archiveSearchInput.value.trim() || btn.textContent.trim().split(' ').slice(1).join(' ');
                    archiveSearchInput.value = query;
                    performArchiveSearch();
                } else {
                    archiveSelectedCollection = null;
                }
            });
        });

        // Search button
        archiveSearchBtn.addEventListener('click', performArchiveSearch);
        archiveSearchInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') performArchiveSearch();
        });

        // Back button
        archiveBackBtn.addEventListener('click', () => {
            archiveShowView.style.display = 'none';
            archiveSearchView.style.display = 'block';
        });

        async function performArchiveSearch() {
            const query = archiveSearchInput.value.trim();
            if (!query) return;

            const year = archiveYearInput.value.trim();
            archiveSearchBtn.disabled = true;
            archiveSearchBtn.textContent = '...';
            archiveResults.innerHTML = '<div class="archive-loading">🔍 Searching archive.org...</div>';

            try {
                let url = `${API_BASE}/archive/search?q=${encodeURIComponent(query)}&rows=30`;
                if (archiveSelectedCollection) url += `&collection=${archiveSelectedCollection}`;
                if (year) url += `&year=${year}`;

                const resp = await fetch(url);
                const data = await resp.json();

                if (!resp.ok) {
                    archiveResults.innerHTML = `<div class="archive-empty">Error: ${data.error || 'Search failed'}</div>`;
                    return;
                }

                if (!data.results || data.results.length === 0) {
                    archiveResults.innerHTML = '<div class="archive-empty">No shows found. Try a different search.</div>';
                    return;
                }

                archiveResults.innerHTML = data.results.map(show => `
                    <div class="archive-show-card" onclick="loadArchiveShow('${show.identifier}')">
                        <div class="archive-show-title">${escapeHtml(show.title)}</div>
                        <div class="archive-show-meta">
                            ${show.date ? `<span>📅 ${show.date}</span>` : ''}
                            ${show.venue ? `<span>📍 ${escapeHtml(show.venue)}</span>` : ''}
                            ${show.avg_rating ? `<span class="archive-show-rating">⭐ ${show.avg_rating.toFixed(1)}</span>` : ''}
                            ${show.source ? `<span>🎙️ ${show.source.substring(0, 30)}</span>` : ''}
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                archiveResults.innerHTML = `<div class="archive-empty">Search failed: ${err.message}</div>`;
            } finally {
                archiveSearchBtn.disabled = false;
                archiveSearchBtn.textContent = 'Search';
            }
        }

        // Make globally accessible
        window.loadArchiveShow = async function(identifier) {
            archiveSearchView.style.display = 'none';
            archiveShowView.style.display = 'block';
            archiveShowDetails.innerHTML = '<div class="archive-loading">Loading show details...</div>';

            try {
                const resp = await fetch(`${API_BASE}/archive/show/${identifier}`);
                const data = await resp.json();

                if (!resp.ok) {
                    archiveShowDetails.innerHTML = `<div class="archive-empty">Error: ${data.error}</div>`;
                    return;
                }

                const show = data.show || {};
                let html = `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-size: 1.1rem; font-weight: 600; color: var(--text);">${escapeHtml(show.title || identifier)}</div>
                        <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 0.25rem;">
                            ${show.date ? `📅 ${show.date}` : ''} ${show.venue ? `• 📍 ${escapeHtml(show.venue)}` : ''} ${show.source ? `• 🎙️ ${escapeHtml(show.source)}` : ''}
                        </div>
                    </div>
                `;

                if (data.setlist && data.setlist.length > 0) {
                    html += `<div style="font-size: 0.75rem; color: var(--psych-teal); margin-bottom: 0.5rem;">
                        Setlist: ${data.setlist.slice(0, 8).map(s => escapeHtml(s)).join(' → ')}${data.setlist.length > 8 ? ' ...' : ''}
                    </div>`;
                }

                if (data.tracks && data.tracks.length > 0) {
                    html += `<div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.5rem;">${data.tracks.length} tracks available</div>`;
                    html += data.tracks.map((track, i) => `
                        <div class="archive-track-row">
                            <span class="archive-track-num">${track.track_number || (i + 1)}</span>
                            <span class="archive-track-title">${escapeHtml(track.title || track.filename)}</span>
                            <button class="archive-track-btn" onclick="processArchiveTrack('${identifier}', '${escapeHtml(track.filename)}', '${escapeHtml(track.title || track.filename)}')">
                                ✦ Process
                            </button>
                        </div>
                    `).join('');

                    html += `<button class="archive-process-all-btn" onclick="processArchiveBatch('${identifier}')">
                        ✦ Process All ${data.tracks.length} Tracks
                    </button>`;
                } else {
                    html += '<div class="archive-empty">No audio tracks found for this show.</div>';
                }

                archiveShowDetails.innerHTML = html;

            } catch (err) {
                archiveShowDetails.innerHTML = `<div class="archive-empty">Failed to load show: ${err.message}</div>`;
            }
        };

        // Process a single track from the archive
        window.processArchiveTrack = async function(identifier, filename, title) {
            // Switch to processing view
            uploadSection.style.display = 'none';
            processingSection.classList.add('active');
            resultsSection.classList.remove('active');

            displayedProgress = 0;
            targetProgress = 0;
            lastProgressUpdate = Date.now();
            updateProgressDisplay(0);
            document.getElementById('stageText').textContent = `Processing: ${title}`;
            startProgressAnimation();
            document.querySelectorAll('.city').forEach(c => c.classList.remove('visited'));
            document.getElementById('city-sf').classList.add('visited');

            try {
                const resp = await fetch(`${API_BASE}/archive/process`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        identifier: identifier,
                        filename: filename,
                        chord_detection: true,
                        gp_tabs: true,
                    })
                });
                const data = await resp.json();
                if (data.job_id) {
                    currentJobId = data.job_id;
                    pollStatus();
                }
            } catch (err) {
                document.getElementById('stageText').textContent = `Error: ${err.message}`;
            }
        };

        // Batch process entire show
        window.processArchiveBatch = async function(identifier) {
            try {
                const resp = await fetch(`${API_BASE}/archive/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        identifier: identifier,
                        chord_detection: true,
                        gp_tabs: true,
                    })
                });
                const data = await resp.json();
                if (data.jobs && data.jobs.length > 0) {
                    // Process first track visually, rest run in background
                    currentJobId = data.jobs[0].job_id;
                    uploadSection.style.display = 'none';
                    processingSection.classList.add('active');
                    resultsSection.classList.remove('active');
                    displayedProgress = 0;
                    targetProgress = 0;
                    lastProgressUpdate = Date.now();
                    updateProgressDisplay(0);
                    document.getElementById('stageText').textContent = `Processing: ${data.jobs[0].title} (1 of ${data.jobs.length})`;
                    startProgressAnimation();
                    document.querySelectorAll('.city').forEach(c => c.classList.remove('visited'));
                    document.getElementById('city-sf').classList.add('visited');
                    pollStatus();
                    if (data.jobs.length > 1) {
                        showToast(`🎤 ${data.jobs.length} tracks queued from archive.org`);
                    }
                }
            } catch (err) {
                showToast(`Error: ${err.message}`, true);
            }
        };

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // File handling
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });

        function handleFile(file) {
            selectedFile = file;
            document.querySelector('.drop-title').textContent = file.name;
            document.querySelector('.drop-icon').textContent = '✓';
            updateSubmitBtn();
        }

        urlInput.addEventListener('input', updateSubmitBtn);

        function updateSubmitBtn() {
            if (currentMode === 'archive') {
                submitBtn.style.display = 'none';
            } else {
                submitBtn.style.display = '';
                submitBtn.disabled = currentMode === 'file' ? !selectedFile : !urlInput.value.trim();
            }
        }

        // Submit
        submitBtn.addEventListener('click', startProcessing);

        async function startProcessing() {
            uploadSection.style.display = 'none';
            processingSection.classList.add('active');
            resultsSection.classList.remove('active');

            // Reset progress bar and Tour Bus
            displayedProgress = 0;
            targetProgress = 0;
            lastProgressUpdate = Date.now();
            updateProgressDisplay(0);
            document.getElementById('stageText').textContent = 'Initializing...';

            // Start smooth progress animation
            startProgressAnimation();

            // Reset cities (SF starts visited)
            document.querySelectorAll('.city').forEach(c => c.classList.remove('visited'));
            document.getElementById('city-sf').classList.add('visited');

            try {
                let response;
                // Get notation settings (audio processing is now fully automatic)
                const gpTabs = document.getElementById('gpTabsToggle')?.checked ?? true;
                const chordDetection = document.getElementById('chordDetectionToggle')?.checked ?? true;

                if (currentMode === 'file') {
                    const formData = new FormData();
                    formData.append('file', selectedFile);
                    formData.append('gp_tabs', gpTabs.toString());
                    formData.append('chord_detection', chordDetection.toString());
                    response = await fetch(`${API_BASE}/upload`, { method: 'POST', body: formData });
                } else {
                    response = await fetch(`${API_BASE}/url`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            url: urlInput.value.trim(),
                            gp_tabs: gpTabs,
                            chord_detection: chordDetection
                        })
                    });
                }
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                currentJobId = data.job_id;
                pollStatus();
            } catch (error) {
                alert('Error: ' + error.message);
                resetUI();
            }
        }

        // Smooth progress animation system
        function updateProgressDisplay(progress) {
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('busTrail').style.width = `${progress}%`;
            document.getElementById('tourBus').style.left = `${progress}%`;
            document.getElementById('progressText').textContent = `${Math.round(progress)}%`;

            // Light up cities as we pass them
            document.getElementById('city-denver').classList.toggle('visited', progress >= 25);
            document.getElementById('city-chicago').classList.toggle('visited', progress >= 55);
            document.getElementById('city-nyc').classList.toggle('visited', progress >= 90);
        }

        function animateProgress() {
            const now = Date.now();
            const timeSinceUpdate = now - lastProgressUpdate;

            // Creep forward slowly during long operations (max 0.5% per second)
            const creepRate = 0.0005; // 0.05% per 100ms
            const maxCreep = Math.min(targetProgress - 1, displayedProgress + (timeSinceUpdate * creepRate));

            if (displayedProgress < targetProgress) {
                // Smoothly interpolate towards target (ease-out effect)
                const diff = targetProgress - displayedProgress;
                const step = Math.max(0.1, diff * 0.15); // Move 15% of remaining distance
                displayedProgress = Math.min(targetProgress, displayedProgress + step);
                updateProgressDisplay(displayedProgress);
            } else if (displayedProgress < maxCreep && targetProgress < 100) {
                // Creep slowly when waiting for next update (makes it feel alive)
                displayedProgress = Math.min(maxCreep, displayedProgress + 0.05);
                updateProgressDisplay(displayedProgress);
            }

            progressAnimationId = requestAnimationFrame(animateProgress);
        }

        function startProgressAnimation() {
            if (!progressAnimationId) {
                displayedProgress = 0;
                targetProgress = 0;
                lastProgressUpdate = Date.now();
                progressAnimationId = requestAnimationFrame(animateProgress);
            }
        }

        function stopProgressAnimation() {
            if (progressAnimationId) {
                cancelAnimationFrame(progressAnimationId);
                progressAnimationId = null;
            }
        }

        async function pollStatus() {
            try {
                const response = await fetch(`${API_BASE}/status/${currentJobId}`);
                const job = await response.json();
                document.getElementById('stageText').textContent = job.stage || 'Processing...';

                // Update target progress (animation system handles smooth display)
                const progress = job.progress || 0;
                if (progress > targetProgress) {
                    targetProgress = progress;
                    lastProgressUpdate = Date.now();
                }

                if (job.status === 'completed') {
                    targetProgress = 100;
                    displayedProgress = 100;
                    updateProgressDisplay(100);
                    stopProgressAnimation();
                    showResults(job);
                } else if (job.status === 'failed') {
                    stopProgressAnimation();
                    alert('Failed: ' + job.error);
                    resetUI();
                } else {
                    setTimeout(pollStatus, 1000);
                }
            } catch (error) {
                setTimeout(pollStatus, 2000);
            }
        }

        // Mixer state
        let stemAudios = {};
        let isPlaying = false;
        let duration = 0;
        let currentJob = null;
        let soloedStems = new Set();
        let trackInfoLoaded = false;
        let currentTrackInfo = null;

        // ============ Track Info Functions ============
        async function toggleTrackInfo() {
            const panel = document.getElementById('trackInfoPanel');
            const btn = document.getElementById('infoToggleBtn');

            if (panel.style.display === 'none' || panel.style.display === '') {
                // Show panel
                panel.style.display = 'block';
                btn.classList.add('active');

                // Show already-loaded data OR fetch if not loaded
                if (trackInfoLoaded && currentTrackInfo) {
                    displayTrackInfo(currentTrackInfo);
                } else {
                    await fetchTrackInfo();
                }
            } else {
                // Hide panel
                panel.style.display = 'none';
                btn.classList.remove('active');
            }
        }

        async function fetchTrackInfo() {
            const loadingEl = document.getElementById('infoLoading');
            const bodyEl = document.getElementById('infoBody');

            loadingEl.style.display = 'flex';
            loadingEl.innerHTML = '<div class="info-spinner"></div><span>Loading track info...</span>';
            bodyEl.style.display = 'none';

            // Get job ID from currentJob or currentJobId
            const jobId = currentJob?.job_id || currentJobId;

            if (!jobId) {
                loadingEl.innerHTML = `
                    <span style="color: var(--psych-pink);">
                        ❌ No job available - process a song first
                    </span>`;
                return;
            }

            try {
                // Add timeout to prevent infinite hang
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(`${API_BASE}/info/${jobId}`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }

                const info = await response.json();

                if (info.error) {
                    throw new Error(info.error);
                }

                currentTrackInfo = info;
                trackInfoLoaded = true;

                displayTrackInfo(info);

            } catch (error) {
                console.error('Failed to fetch track info:', error);
                const isTimeout = error.name === 'AbortError';
                loadingEl.innerHTML = `
                    <span style="color: var(--psych-pink);">
                        ${isTimeout ? '⏱️ Request timed out (10s)' : '❌ ' + error.message}
                    </span>
                    <button onclick="fetchTrackInfo()" style="margin-top: 10px; padding: 5px 15px; background: var(--psych-orange); border: none; border-radius: 4px; cursor: pointer; color: white;">
                        Retry
                    </button>`;
            }
        }

        function displayTrackInfo(info) {
            const loadingEl = document.getElementById('infoLoading');
            const bodyEl = document.getElementById('infoBody');

            loadingEl.style.display = 'none';
            bodyEl.style.display = 'block';

            // Store player mapping globally for stem labels
            if (info.player_mapping) {
                window.currentPlayerMapping = info.player_mapping;
                updateStemLabels(info.player_mapping);
            }

            // Album info
            const albumSection = document.getElementById('albumSection');
            if (info.album) {
                document.getElementById('albumName').textContent = info.album;
                document.getElementById('albumYear').textContent = info.album_year || '';
                document.getElementById('albumDescription').textContent = info.album_description || '';
                albumSection.style.display = 'block';
            } else {
                albumSection.style.display = 'none';
            }

            // Era info (for Grateful Dead)
            const eraSection = document.getElementById('eraSection');
            if (info.era) {
                document.getElementById('eraKeyboardist').textContent = info.era.keyboardist;
                document.getElementById('eraYears').textContent = `(${info.era.years})`;
                document.getElementById('eraNotes').textContent = info.era.notes;
                eraSection.style.display = 'block';
            } else {
                eraSection.style.display = 'none';
            }

            // Artist bio
            const bioSection = document.getElementById('artistBioSection');
            const bioEl = document.getElementById('artistBio');
            const wikiLink = document.getElementById('wikiLink');

            if (info.bio) {
                bioEl.textContent = info.bio;
                bioSection.style.display = 'block';
                if (info.wikipedia_url) {
                    wikiLink.href = info.wikipedia_url;
                    wikiLink.style.display = 'inline-block';
                }
            } else {
                bioSection.style.display = 'none';
            }

            // Song info
            const songSection = document.getElementById('songInfoSection');
            const songEl = document.getElementById('songInfo');
            const songWikiLink = document.getElementById('songWikiLink');
            const geniusLink = document.getElementById('geniusLink');

            // Show song section if we have song info, Wikipedia, OR Genius link
            if (info.song_info || info.song_wikipedia_url || info.genius_url) {
                songEl.textContent = info.song_info || 'Click links below for lyrics and song details.';
                songSection.style.display = 'block';

                // Wikipedia link
                if (info.song_wikipedia_url) {
                    songWikiLink.href = info.song_wikipedia_url;
                    songWikiLink.style.display = 'inline-block';
                } else {
                    songWikiLink.style.display = 'none';
                }

                // Genius link (shows for almost every song)
                if (info.genius_url) {
                    geniusLink.href = info.genius_url;
                    geniusLink.style.display = 'inline-block';
                } else {
                    geniusLink.style.display = 'none';
                }
            } else {
                songSection.style.display = 'none';
            }

            // Album personnel (specific to this recording)
            const personnelSection = document.getElementById('personnelSection');
            const personnelList = document.getElementById('personnelList');
            if (info.personnel && Object.keys(info.personnel).length > 0) {
                personnelList.innerHTML = '';
                for (const [name, role] of Object.entries(info.personnel)) {
                    const item = document.createElement('div');
                    item.className = 'personnel-item';
                    item.innerHTML = `
                        <span class="name">${name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}</span>
                        <span class="role">${role}</span>
                    `;
                    personnelList.appendChild(item);
                }
                personnelSection.style.display = 'block';
            } else {
                personnelSection.style.display = 'none';
            }

            // Band members (general info)
            const membersSection = document.getElementById('membersSection');
            const membersList = document.getElementById('membersList');
            if (info.members && Object.keys(info.members).length > 0 && !info.personnel) {
                membersList.innerHTML = '';
                for (const [name, role] of Object.entries(info.members)) {
                    const item = document.createElement('div');
                    item.className = 'member-item';
                    item.innerHTML = `
                        <div class="name">${name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}</div>
                        <div class="role">${role}</div>
                    `;
                    membersList.appendChild(item);
                }
                membersSection.style.display = 'block';
            } else {
                membersSection.style.display = 'none';
            }

            // Learning tips
            const tipsSection = document.getElementById('learningTipsSection');
            const tipsEl = document.getElementById('learningTips');
            if (info.learning_tips) {
                tipsEl.textContent = info.learning_tips;
                tipsSection.style.display = 'block';
            } else {
                tipsSection.style.display = 'none';
            }

            // Stem-specific tips (use player names if available)
            const stemTipsSection = document.getElementById('stemTipsSection');
            const stemTipsList = document.getElementById('stemTipsList');
            if (info.stem_tips && Object.keys(info.stem_tips).length > 0) {
                stemTipsList.innerHTML = '';
                for (const [stem, tip] of Object.entries(info.stem_tips)) {
                    const displayName = info.player_mapping?.[stem] || stem.replace('_', ' ');
                    const item = document.createElement('div');
                    item.className = 'stem-tip';
                    item.innerHTML = `
                        <div class="stem-name">${displayName}</div>
                        <div class="tip-text">${tip}</div>
                    `;
                    stemTipsList.appendChild(item);
                }
                stemTipsSection.style.display = 'block';
            } else {
                stemTipsSection.style.display = 'none';
            }

            // Style
            const styleSection = document.getElementById('styleSection');
            const styleEl = document.getElementById('styleInfo');
            if (info.style) {
                styleEl.textContent = info.style;
                styleSection.style.display = 'block';
            } else {
                styleSection.style.display = 'none';
            }
        }

        // Update stem card labels with player names
        function updateStemLabels(playerMapping) {
            if (!playerMapping) return;

            // Find all stem cards and update their labels
            const stemCards = document.querySelectorAll('.stem-card');
            stemCards.forEach(card => {
                const stemName = card.dataset.stem;
                if (stemName && playerMapping[stemName]) {
                    const labelEl = card.querySelector('.stem-name');
                    if (labelEl) {
                        // Store original name as data attribute
                        if (!labelEl.dataset.originalName) {
                            labelEl.dataset.originalName = labelEl.textContent;
                        }
                        // Show player name with original in parentheses
                        const playerName = playerMapping[stemName];
                        labelEl.innerHTML = `${playerName} <span class="stem-original">(${stemName})</span>`;
                    }
                }
            });
        }

        function showResults(job) {
            processingSection.classList.remove('active');
            resultsSection.classList.add('active');
            currentJob = job;

            // Reset mixer state
            stemAudios = {};
            isPlaying = false;
            soloedStems.clear();
            document.getElementById('masterPlayBtn').textContent = '▶';

            if (job.metadata?.title) {
                document.getElementById('songCard').style.display = 'flex';
                document.getElementById('songTitle').textContent = job.metadata.title;
                document.getElementById('songArtist').textContent = job.metadata.artist || 'Unknown';
                if (job.metadata.thumbnail) document.getElementById('songThumb').src = job.metadata.thumbnail;
                // Show info button and reset panel
                document.getElementById('infoToggleBtn').style.display = 'block';
            } else {
                // For file uploads, still show the song card with filename
                document.getElementById('songCard').style.display = 'flex';
                document.getElementById('songTitle').textContent = job.filename || 'Uploaded Track';
                document.getElementById('songArtist').textContent = 'Tap ℹ️ for track info';
                document.getElementById('songThumb').src = '';
                document.getElementById('infoToggleBtn').style.display = 'block';
            }

            // Reset track info panel
            document.getElementById('trackInfoPanel').style.display = 'none';
            document.getElementById('infoToggleBtn').classList.remove('active');
            trackInfoLoaded = false;

            const grid = document.getElementById('stemsGrid');
            grid.innerHTML = '';

            // Preferred order: primary stems first, then deep-extracted stems
            const stemOrder = [
                'vocals', 'vocals_lead', 'vocals_backing', 'backing_vocals',
                'guitar', 'guitar_2',
                'bass', 'bass_2',
                'drums', 'percussion_2',
                'piano', 'keys_2',
                'other',
                'other_vocals', 'other_guitar', 'other_bass', 'other_drums', 'other_piano', 'other_other',
                'other_deep',
            ];
            const sortedStems = Object.entries(job.stems).sort((a, b) => {
                const aIdx = stemOrder.indexOf(a[0]);
                const bIdx = stemOrder.indexOf(b[0]);
                // Items not in list go to end
                if (aIdx === -1 && bIdx === -1) return 0;
                if (aIdx === -1) return 1;
                if (bIdx === -1) return -1;
                return aIdx - bIdx;
            });

            // Check if we have deep-extracted stems (from smart_separate)
            // Vocal splits (lead/backing) are primary-tier, not deep-extracted
            const primaryStems = ['vocals', 'vocals_lead', 'vocals_backing', 'drums', 'bass', 'guitar', 'piano', 'other'];
            const hasCascadedStems = sortedStems.some(([name]) => !primaryStems.includes(name));

            // Wrap grid in Neve console
            const existingConsole = document.querySelector('.neve-console');
            if (!existingConsole) {
                const neveConsole = document.createElement('div');
                neveConsole.className = 'neve-console';

                // Add decorative screws
                const screwPositions = [
                    { top: '8px', left: '8px' },
                    { top: '8px', right: '8px' },
                    { bottom: '45px', left: '8px' },
                    { bottom: '45px', right: '8px' }
                ];
                screwPositions.forEach(pos => {
                    const screw = document.createElement('div');
                    screw.className = 'neve-screw';
                    Object.assign(screw.style, pos);
                    neveConsole.appendChild(screw);
                });

                // Add leather armrest
                const armrest = document.createElement('div');
                armrest.className = 'neve-armrest';

                // Add bolster ends
                const leftEnd = document.createElement('div');
                leftEnd.className = 'neve-armrest-end left';
                armrest.appendChild(leftEnd);

                const rightEnd = document.createElement('div');
                rightEnd.className = 'neve-armrest-end right';
                armrest.appendChild(rightEnd);

                neveConsole.appendChild(armrest);

                grid.parentNode.insertBefore(neveConsole, grid);
                neveConsole.appendChild(grid);
            }

            let cascadeHeaderAdded = false;
            sortedStems.forEach(([name, path]) => {
                const isPrimary = primaryStems.includes(name);
                // Add extracted stems section header
                if (hasCascadedStems && !isPrimary && !cascadeHeaderAdded) {
                    cascadeHeaderAdded = true;
                    const cascadeHeader = document.createElement('div');
                    cascadeHeader.className = 'cascade-stems-header';
                    cascadeHeader.innerHTML = `<span>🧠 Deep Extraction (auto-detected instruments)</span>`;
                    cascadeHeader.style.cssText = 'grid-column: 1/-1; text-align:center; padding:1rem 0 0.5rem; font-family:Righteous; color:var(--psych-purple); border-top:2px solid rgba(198,120,221,0.4); margin-top:0.5rem; font-size: 0.9rem;';
                    grid.appendChild(cascadeHeader);
                }

                const cfg = stemConfig[name] || { icon: '🎵', color: '#888', label: name.replace(/_/g, ' ').toUpperCase() };
                const hasMidi = job.midi_files?.[name];
                const isCascaded = cfg.extracted || !isPrimary;

                const card = document.createElement('div');
                card.className = isCascaded ? 'stem-card cascaded-stem' : 'stem-card';
                card.id = `stem-${name}`;
                card.dataset.stem = name;  // For player name mapping
                card.style.setProperty('--stem-color', cfg.color);

                // Check if we have a player mapping for this stem
                const playerName = window.currentPlayerMapping?.[name];
                const displayLabel = playerName
                    ? `${playerName} <span class="stem-original">(${name})</span>`
                    : (cfg.label || name);

                card.innerHTML = `
                    ${isCascaded ? '<div class="cascade-badge">🧠</div>' : ''}
                    <div class="stem-icon">${cfg.icon}</div>
                    <div class="stem-name">${displayLabel}</div>

                    <!-- Big VU Needle Meter at Top -->
                    <div class="vu-meter" id="vu-meter-${name}">
                        <div class="vu-face">
                            <div class="vu-scale"></div>
                            <div class="vu-red-zone"></div>
                            <div class="vu-needle" id="vu-needle-${name}"></div>
                            <div class="vu-label">VU</div>
                        </div>
                    </div>

                    <div class="stem-mixer-controls">
                        <button class="mute-btn" data-stem="${name}">M</button>
                        <button class="solo-btn" data-stem="${name}">S</button>
                    </div>

                    <!-- Fader with LED beside it -->
                    <div class="fader-section">
                        <!-- LED Bar Meter -->
                        <div class="led-meter">
                            <div class="peak-led" id="peak-led-${name}"></div>
                            <div class="led-meter-track">
                                <div class="led-meter-fill" id="meter-fill-${name}"></div>
                                <div class="led-meter-segments"></div>
                            </div>
                        </div>

                        <!-- Vertical Fader -->
                        <div class="stem-volume">
                            <div class="fader-track" id="fader-track-${name}">
                                <div class="fader-groove"></div>
                                <div class="fader-cap" id="fader-cap-${name}" style="top: 24px;"></div>
                                <input type="range" class="stem-volume-slider" data-stem="${name}" min="0" max="100" value="80">
                            </div>
                        </div>
                    </div>

                    <div class="stem-actions">
                        ${job.enhanced_stems?.[name] ?
                            `<a href="${API_BASE}/download/${job.job_id}/enhanced/${name}" class="stem-btn enhanced" download title="Enhanced (cleaner)">⬇ ✨</a>
                             <a href="${API_BASE}/download/${job.job_id}/stem/${name}" class="stem-btn raw" download title="Raw stem">⬇ Raw</a>` :
                            `<a href="${API_BASE}/download/${job.job_id}/stem/${name}" class="stem-btn" download>⬇ DL</a>`
                        }
                        ${(job.musicxml_files?.[name] || job.gp_files?.[name]) ? `<button class="stem-btn notation" onclick="openNotationForStem('${name}')" title="Open in Practice Mode">▶ TAB</button>` : ''}
                        ${job.musicxml_files?.[name] ? `<button class="stem-btn notation" onclick="exportPDFForStem('${name}')" title="Export sheet music as PDF">📄 PDF</button>` : ''}
                        ${hasMidi ? `<a href="${API_BASE}/download/${job.job_id}/midi/${name}" class="stem-btn midi" download title="Download MIDI file">🎹</a>` : ''}
                    </div>
                    <audio id="audio-${name}" src="${job.enhanced_stems?.[name] ? API_BASE + '/download/' + job.job_id + '/enhanced/' + name : API_BASE + '/download/' + job.job_id + '/stem/' + name}" preload="auto"></audio>
                `;
                grid.appendChild(card);

                // Store audio reference
                const audio = card.querySelector(`#audio-${name}`);
                stemAudios[name] = { audio, muted: false, volume: 0.8 };
                audio.volume = 0.8;

                // Initialize fader cap position
                setTimeout(() => updateFaderCap(name, 80), 100);

                // Get duration from first loaded audio
                audio.addEventListener('loadedmetadata', () => {
                    if (duration === 0) {
                        duration = audio.duration;
                        document.getElementById('totalTime').textContent = formatTime(duration);
                    }
                });
            });

            // Add sub-stems from skills (if any)
            if (job.sub_stems && Object.keys(job.sub_stems).length > 0) {
                if (useHierarchicalLayout) {
                    // OPTION B: Hierarchical - nest sub-stems under parent
                    addHierarchicalSubstems(job, grid);
                } else {
                    // OPTION A: Dynamic/Flat - all stems in one row
                    addFlatSubstems(job, grid);
                }
            }

            // Setup mixer controls
            setupMixerControls();

            // Auto-fetch track info for player names (silently, without showing panel)
            autoFetchPlayerNames();
        }

        // Silently fetch track info to get player names for stems
        async function autoFetchPlayerNames() {
            if (!currentJob) return;

            try {
                const response = await fetch(`${API_BASE}/info/${currentJob.job_id}`);
                const info = await response.json();

                currentTrackInfo = info;
                trackInfoLoaded = true;

                // Update stem labels with player names
                if (info.player_mapping) {
                    window.currentPlayerMapping = info.player_mapping;
                    updateStemLabels(info.player_mapping);
                }

            } catch (error) {
                console.log('Could not auto-fetch player names:', error);
            }
        }

        // Option A: Flat sub-stem layout
        function addFlatSubstems(job, grid) {
            const skillHeader = document.createElement('div');
            skillHeader.className = 'skill-stems-header';
            skillHeader.innerHTML = `<span>🎯 Skill-Enhanced Stems</span>`;
            skillHeader.style.cssText = 'grid-column: 1/-1; text-align:center; padding:1rem 0 0.5rem; font-family:Righteous; color:var(--psych-orange); border-top:1px solid rgba(255,123,84,0.3); margin-top:0.5rem;';
            grid.appendChild(skillHeader);

            Object.entries(job.sub_stems).forEach(([skillId, subStems]) => {
                const skill = availableSkills.find(s => s.id === skillId);
                Object.entries(subStems).forEach(([subStemName, relPath]) => {
                    const filename = relPath.split('/').pop();
                    const displayName = subStemName.replace(/_/g, ' ').toUpperCase();
                    const color = subStemColors[subStemName] || '#c678dd';
                    addSubStemCard(grid, job, skillId, subStemName, filename, displayName, color, skill);
                });
            });
        }

        // Option B: Hierarchical sub-stem layout
        function addHierarchicalSubstems(job, grid) {
            const skillParentMap = { 'vocal_virtuoso': 'vocals', 'horn_hunter': 'other', 'guitar_god': 'guitar', 'string_section': 'other', 'keys_kingdom': 'piano' };

            Object.entries(job.sub_stems).forEach(([skillId, subStems]) => {
                const skill = availableSkills.find(s => s.id === skillId);
                const parentStem = skillParentMap[skillId] || 'other';
                const parentCard = document.getElementById(`stem-${parentStem}`);

                if (parentCard) {
                    parentCard.classList.add('has-substems');
                    if (!parentCard.querySelector('.substems-toggle')) {
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = 'substems-toggle';
                        toggleBtn.innerHTML = `${skill?.emoji || '🎯'} +${Object.keys(subStems).length}`;
                        toggleBtn.onclick = (e) => { e.stopPropagation(); toggleSubstems(parentStem); };
                        parentCard.appendChild(toggleBtn);
                    }

                    let container = document.getElementById(`substems-${parentStem}`);
                    if (!container) {
                        container = document.createElement('div');
                        container.className = 'substems-container';
                        container.id = `substems-${parentStem}`;
                        container.innerHTML = `<div class="substem-parent-label">${skill?.name || skillId} sub-stems</div><div class="substems-grid"></div>`;
                        parentCard.after(container);
                    }

                    const subGrid = container.querySelector('.substems-grid');
                    Object.entries(subStems).forEach(([subStemName, relPath]) => {
                        const filename = relPath.split('/').pop();
                        const displayName = subStemName.replace(/_/g, ' ');

                        const miniCard = document.createElement('div');
                        miniCard.className = 'substem-mini-card';
                        miniCard.innerHTML = `
                            <div class="emoji">${skill?.emoji || '🎯'}</div>
                            <div class="name">${displayName}</div>
                            <div class="mini-controls">
                                <button class="mini-btn" onclick="toggleMiniMute('${subStemName}', this)">M</button>
                                <a href="${API_BASE}/download/${job.job_id}/substem/${skillId}/${filename}" class="mini-btn" download>⬇</a>
                            </div>
                            <audio id="audio-${subStemName}" src="${API_BASE}/download/${job.job_id}/substem/${skillId}/${filename}" preload="auto"></audio>
                        `;
                        subGrid.appendChild(miniCard);

                        const audio = miniCard.querySelector(`#audio-${subStemName}`);
                        stemAudios[subStemName] = { audio, muted: false, volume: 0.8, isSubStem: true };
                        audio.volume = 0.8;
                    });
                }
            });
        }

        function toggleSubstems(parentStem) {
            const container = document.getElementById(`substems-${parentStem}`);
            const toggle = document.querySelector(`#stem-${parentStem} .substems-toggle`);
            if (container) container.classList.toggle('expanded');
            if (toggle) toggle.classList.toggle('expanded');
        }

        function toggleMiniMute(stemName, btn) {
            const stemData = stemAudios[stemName];
            if (stemData) {
                stemData.muted = !stemData.muted;
                stemData.audio.volume = stemData.muted ? 0 : stemData.volume;
                btn.classList.toggle('active', stemData.muted);
                btn.parentElement.parentElement.classList.toggle('muted', stemData.muted);
            }
        }

        function addSubStemCard(grid, job, skillId, subStemName, filename, displayName, color, skill) {
            const card = document.createElement('div');
            card.className = 'stem-card sub-stem';
            card.id = `stem-${subStemName}`;
            card.style.setProperty('--stem-color', color);
            card.innerHTML = `
                <div class="stem-icon">${skill?.emoji || '🎯'}</div>
                <div class="stem-name">${displayName}</div>
                <div class="vu-meter" id="vu-meter-${subStemName}">
                    <div class="vu-face">
                        <div class="vu-scale"></div>
                        <div class="vu-red-zone"></div>
                        <div class="vu-needle" id="vu-needle-${subStemName}"></div>
                        <div class="vu-label">VU</div>
                    </div>
                </div>
                <div class="stem-mixer-controls">
                    <button class="mute-btn" data-stem="${subStemName}">M</button>
                    <button class="solo-btn" data-stem="${subStemName}">S</button>
                </div>
                <div class="fader-section">
                    <div class="led-meter">
                        <div class="peak-led" id="peak-led-${subStemName}"></div>
                        <div class="led-meter-track">
                            <div class="led-meter-fill" id="meter-fill-${subStemName}"></div>
                            <div class="led-meter-segments"></div>
                        </div>
                    </div>
                    <div class="stem-volume">
                        <div class="fader-track" id="fader-track-${subStemName}">
                            <div class="fader-groove"></div>
                            <div class="fader-cap" id="fader-cap-${subStemName}" style="top: 24px;"></div>
                            <input type="range" class="stem-volume-slider" data-stem="${subStemName}" min="0" max="100" value="80">
                        </div>
                    </div>
                </div>
                <div class="stem-actions">
                    <a href="${API_BASE}/download/${job.job_id}/substem/${skillId}/${filename}" class="stem-btn" download>⬇ DL</a>
                </div>
                <audio id="audio-${subStemName}" src="${API_BASE}/download/${job.job_id}/substem/${skillId}/${filename}" preload="auto"></audio>
            `;
            grid.appendChild(card);

            const audio = card.querySelector(`#audio-${subStemName}`);
            stemAudios[subStemName] = { audio, muted: false, volume: 0.8, isSubStem: true };
            audio.volume = 0.8;
            setTimeout(() => updateFaderCap(subStemName, 80), 100);
        }

        function setupMixerControls() {
            // Master play button
            document.getElementById('masterPlayBtn').addEventListener('click', togglePlayback);

            // Master volume
            document.getElementById('masterVolume').addEventListener('input', (e) => {
                const vol = e.target.value / 100;
                Object.values(stemAudios).forEach(s => {
                    s.audio.volume = s.volume * vol * (s.muted ? 0 : 1);
                });
            });

            // Timeline seeking - click and drag support
            const timeline = document.getElementById('timeline');
            const timelineHandle = document.getElementById('timelineHandle');
            let isDraggingTimeline = false;

            function seekToPosition(e) {
                const rect = timeline.getBoundingClientRect();
                const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                const seekTime = percent * duration;
                Object.values(stemAudios).forEach(s => s.audio.currentTime = seekTime);
                updateTimeline();
            }

            timeline.addEventListener('mousedown', (e) => {
                isDraggingTimeline = true;
                seekToPosition(e);
            });

            document.addEventListener('mousemove', (e) => {
                if (isDraggingTimeline) {
                    seekToPosition(e);
                }
            });

            document.addEventListener('mouseup', () => {
                isDraggingTimeline = false;
            });

            // Skip buttons - 10 seconds forward/back
            document.getElementById('skipBackBtn').addEventListener('click', () => {
                const currentTime = Object.values(stemAudios)[0]?.audio.currentTime || 0;
                const newTime = Math.max(0, currentTime - 10);
                Object.values(stemAudios).forEach(s => s.audio.currentTime = newTime);
                updateTimeline();
            });

            document.getElementById('skipForwardBtn').addEventListener('click', () => {
                const currentTime = Object.values(stemAudios)[0]?.audio.currentTime || 0;
                const newTime = Math.min(duration, currentTime + 10);
                Object.values(stemAudios).forEach(s => s.audio.currentTime = newTime);
                updateTimeline();
            });

            // Keyboard controls (like YouTube)
            // Arrow keys: 5 sec skip, Space: play/pause
            document.addEventListener('keydown', (e) => {
                // Don't trigger if typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                // Only work when results section is active
                if (!resultsSection.classList.contains('active')) return;
                if (Object.keys(stemAudios).length === 0) return;

                const currentTime = Object.values(stemAudios)[0]?.audio.currentTime || 0;

                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        const backTime = Math.max(0, currentTime - 5);
                        Object.values(stemAudios).forEach(s => s.audio.currentTime = backTime);
                        updateTimeline();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        const fwdTime = Math.min(duration, currentTime + 5);
                        Object.values(stemAudios).forEach(s => s.audio.currentTime = fwdTime);
                        updateTimeline();
                        break;
                    case ' ':
                        e.preventDefault();
                        togglePlayback();
                        break;
                }
            });

            // Mute buttons
            document.querySelectorAll('.mute-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const stem = btn.dataset.stem;
                    const stemData = stemAudios[stem];
                    stemData.muted = !stemData.muted;
                    btn.classList.toggle('active', stemData.muted);
                    document.getElementById(`stem-${stem}`).classList.toggle('muted', stemData.muted);
                    updateStemVolumes();
                });
            });

            // Solo buttons
            document.querySelectorAll('.solo-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const stem = btn.dataset.stem;
                    if (soloedStems.has(stem)) {
                        soloedStems.delete(stem);
                        btn.classList.remove('active');
                    } else {
                        soloedStems.add(stem);
                        btn.classList.add('active');
                    }
                    updateStemVolumes();
                });
            });

            // Individual volume sliders with fader cap sync
            document.querySelectorAll('.stem-volume-slider').forEach(slider => {
                slider.addEventListener('input', (e) => {
                    const stem = slider.dataset.stem;
                    stemAudios[stem].volume = e.target.value / 100;
                    updateStemVolumes();
                    updateFaderCap(stem, e.target.value);
                });
            });

            // Setup fader cap dragging
            document.querySelectorAll('.fader-track').forEach(track => {
                const stemName = track.id.replace('fader-track-', '');
                const cap = document.getElementById(`fader-cap-${stemName}`);
                const slider = track.querySelector('.stem-volume-slider');

                track.addEventListener('mousedown', (e) => {
                    const updateFaderFromMouse = (e) => {
                        const rect = track.getBoundingClientRect();
                        const y = Math.max(0, Math.min(e.clientY - rect.top, rect.height));
                        const percent = 100 - (y / rect.height * 100);
                        slider.value = percent;
                        slider.dispatchEvent(new Event('input'));
                    };

                    updateFaderFromMouse(e);

                    const onMouseMove = (e) => updateFaderFromMouse(e);
                    const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            });

            // Update timeline during playback
            setInterval(updateTimeline, 100);

            // Start VU meter animation
            startVUMeters();
        }

        function updateFaderCap(stem, value) {
            const cap = document.getElementById(`fader-cap-${stem}`);
            if (cap) {
                // Map 0-100 to track range (8px from top to 88px)
                const position = 8 + (100 - value) * 0.8;
                cap.style.top = `${position}px`;
            }
        }

        // VU Meter Animation (simulated - no AudioContext to avoid audio blocking)
        let vuAnimationId = null;
        let meterLevels = {}; // Smooth meter levels

        function startVUMeters() {
            // Initialize meter levels
            Object.keys(stemAudios).forEach(name => {
                meterLevels[name] = 0;
            });

            // Animation loop - simulated VU that looks realistic
            function animateVU() {
                Object.entries(stemAudios).forEach(([name, data]) => {
                    const meterFill = document.getElementById(`meter-fill-${name}`);
                    const vuNeedle = document.getElementById(`vu-needle-${name}`);
                    const vuMeter = document.getElementById(`vu-meter-${name}`);

                    let targetLevel = 0;

                    if (isPlaying && !data.muted) {
                        // Check solo
                        if (soloedStems.size > 0 && !soloedStems.has(name)) {
                            targetLevel = 0;
                        } else {
                            // Simulate realistic VU movement based on volume + randomness
                            const baseLevel = data.volume * 0.7;
                            const variation = Math.sin(Date.now() / (200 + Math.random() * 100)) * 0.15;
                            const spike = Math.random() > 0.92 ? Math.random() * 0.2 : 0;
                            targetLevel = Math.min(1, baseLevel + variation + spike);
                        }
                    }

                    // Smooth the meter movement (fast attack, slow release)
                    if (targetLevel > meterLevels[name]) {
                        meterLevels[name] += (targetLevel - meterLevels[name]) * 0.3; // Fast attack
                    } else {
                        meterLevels[name] += (targetLevel - meterLevels[name]) * 0.08; // Slow release
                    }

                    const percent = Math.max(0, Math.min(100, meterLevels[name] * 100));

                    // Update LED bar meter (percentage height)
                    if (meterFill) {
                        meterFill.style.height = `${percent}%`;
                    }

                    // Update VU needle meter (rotation from -45deg to +45deg)
                    if (vuNeedle) {
                        // Map 0-100% to -45deg to +45deg rotation
                        const rotation = -45 + (percent * 0.9);
                        vuNeedle.style.transform = `rotate(${rotation}deg)`;
                    }

                    // Light up VU meter when active
                    if (vuMeter) {
                        vuMeter.classList.toggle('lit', percent > 5);
                    }

                    // Update peak LED
                    const peakLed = document.getElementById(`peak-led-${name}`);
                    if (peakLed) {
                        peakLed.classList.toggle('active', percent > 85);
                    }
                });

                vuAnimationId = requestAnimationFrame(animateVU);
            }

            animateVU();
        }

        function updateStemVolumes() {
            const masterVol = document.getElementById('masterVolume').value / 100;
            const hasSolo = soloedStems.size > 0;

            Object.entries(stemAudios).forEach(([name, data]) => {
                let vol = data.volume * masterVol;

                // If any stem is soloed, only play soloed stems
                if (hasSolo && !soloedStems.has(name)) {
                    vol = 0;
                }

                // Apply mute
                if (data.muted) {
                    vol = 0;
                }

                data.audio.volume = vol;
            });
        }

        function togglePlayback() {
            const btn = document.getElementById('masterPlayBtn');
            if (isPlaying) {
                Object.values(stemAudios).forEach(s => s.audio.pause());
                btn.textContent = '▶';
                isPlaying = false;
            } else {
                // Sync all to same time before playing
                const currentTime = Object.values(stemAudios)[0]?.audio.currentTime || 0;
                Object.values(stemAudios).forEach(s => {
                    s.audio.currentTime = currentTime;
                    s.audio.play();
                });
                btn.textContent = '⏸';
                isPlaying = true;
            }
        }

        function updateTimeline() {
            if (Object.keys(stemAudios).length === 0) return;
            const audio = Object.values(stemAudios)[0].audio;
            const percent = (audio.currentTime / duration) * 100 || 0;
            document.getElementById('timelineProgress').style.width = `${percent}%`;
            document.getElementById('timelineHandle').style.left = `${percent}%`;
            document.getElementById('currentTime').textContent = formatTime(audio.currentTime);

            // Loop back to start when finished
            if (audio.currentTime >= duration - 0.1 && isPlaying) {
                Object.values(stemAudios).forEach(s => s.audio.currentTime = 0);
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function openPracticeMode() {
            if (currentJobId) {
                window.open(`practice.html?job=${currentJobId}`, '_blank');
            } else {
                window.open('practice.html', '_blank');
            }
        }

        function openNotationForStem(stemName) {
            if (currentJobId) {
                window.open(`practice.html?job=${currentJobId}&stem=${stemName}`, '_blank');
            } else {
                window.open('practice.html', '_blank');
            }
        }

        function exportPDFForStem(stemName) {
            if (currentJobId) {
                window.open(`practice.html?job=${currentJobId}&stem=${stemName}&autoExportPDF=true`, '_blank');
            }
        }

        function resetUI() {
            // Stop progress animation
            stopProgressAnimation();

            // Stop VU meter animation
            if (vuAnimationId) {
                cancelAnimationFrame(vuAnimationId);
                vuAnimationId = null;
            }
            // Close audio contexts
            Object.values(audioContexts).forEach(ctx => {
                if (ctx?.ctx) ctx.ctx.close();
            });
            audioContexts = {};
            // Stop any playing audio
            Object.values(stemAudios).forEach(s => s.audio.pause());
            stemAudios = {};
            isPlaying = false;
            uploadSection.style.display = 'block';
            processingSection.classList.remove('active');
            resultsSection.classList.remove('active');
            selectedFile = null;
            document.querySelector('.drop-title').textContent = 'Drop your track here';
            document.querySelector('.drop-icon').textContent = '🎧';
            urlInput.value = '';
            submitBtn.disabled = true;
        }

        // ============ Settings Panel ============
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const settingsOverlay = document.getElementById('settingsOverlay');
        const closeSettings = document.getElementById('closeSettings');

        settingsBtn.addEventListener('click', () => {
            settingsPanel.classList.add('open');
            settingsOverlay.classList.add('open');
            checkDriveStatus();
            loadLocalStats();
        });

        closeSettings.addEventListener('click', closeSettingsPanel);
        settingsOverlay.addEventListener('click', closeSettingsPanel);

        function closeSettingsPanel() {
            settingsPanel.classList.remove('open');
            settingsOverlay.classList.remove('open');
        }

        // ============ Library Panel ============
        const libraryBtn = document.getElementById('libraryBtn');
        const libraryPanel = document.getElementById('libraryPanel');
        const libraryOverlay = document.getElementById('libraryOverlay');
        const closeLibrary = document.getElementById('closeLibrary');
        const libraryList = document.getElementById('libraryList');

        libraryBtn.addEventListener('click', () => {
            libraryPanel.classList.add('open');
            libraryOverlay.classList.add('open');
            loadLibrary();
        });

        closeLibrary.addEventListener('click', closeLibraryPanel);
        libraryOverlay.addEventListener('click', closeLibraryPanel);

        function closeLibraryPanel() {
            libraryPanel.classList.remove('open');
            libraryOverlay.classList.remove('open');
        }

        async function loadLibrary() {
            libraryList.innerHTML = '<div class="library-loading">Loading library...</div>';

            try {
                const response = await fetch(`${API_BASE}/library`);
                const data = await response.json();

                if (data.library && data.library.length > 0) {
                    libraryList.innerHTML = data.library.map(item => `
                        <div class="library-item" onclick="loadFromLibrary('${item.job_id}')">
                            <div class="library-item-header">
                                ${item.thumbnail
                                    ? `<img src="${item.thumbnail}" class="library-item-thumb" alt="">`
                                    : `<div class="library-item-thumb" style="display:flex;align-items:center;justify-content:center;font-size:1.5rem;">🎵</div>`
                                }
                                <div class="library-item-info">
                                    <div class="library-item-title">${item.title || 'Unknown Track'}</div>
                                    <div class="library-item-artist">${item.artist || 'Unknown Artist'}</div>
                                </div>
                                <button class="library-item-delete" onclick="event.stopPropagation(); deleteFromLibrary('${item.job_id}')" title="Remove from library">🗑️</button>
                            </div>
                            <div class="library-item-meta">
                                <span>🎚️ ${item.stem_count} stems</span>
                                ${item.has_midi ? '<span>🎹 MIDI</span>' : ''}
                                ${item.has_gp ? '<span>🎸 Tabs</span>' : ''}
                                <span>📅 ${new Date(item.created_at * 1000).toLocaleDateString()}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    libraryList.innerHTML = `
                        <div class="library-empty">
                            <p>📭 No songs in your library yet</p>
                            <p style="font-size:0.85rem; margin-top:0.5rem;">Process a song to add it to your library</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load library:', error);
                libraryList.innerHTML = '<div class="library-empty">Failed to load library</div>';
            }
        }

        async function loadFromLibrary(jobId) {
            closeLibraryPanel();
            showToast('Loading from library...');

            try {
                const response = await fetch(`${API_BASE}/status/${jobId}`);
                const job = await response.json();

                if (job.status === 'completed') {
                    currentJobId = jobId;
                    showResults(job);
                    showToast(`✓ Loaded: ${job.metadata?.title || 'Track'}`);
                } else {
                    showToast('Job not ready', 'error');
                }
            } catch (error) {
                console.error('Failed to load from library:', error);
                showToast('Failed to load track', 'error');
            }
        }

        async function deleteFromLibrary(jobId) {
            if (!confirm('Remove this song from your library? The files will be deleted.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/library/${jobId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('Removed from library');
                    loadLibrary();  // Refresh the list
                } else {
                    showToast('Failed to delete', 'error');
                }
            } catch (error) {
                console.error('Failed to delete from library:', error);
                showToast('Failed to delete', 'error');
            }
        }

        // ============ Mixer Layout Toggle ============
        let useHierarchicalLayout = localStorage.getItem('mixerLayout') === 'hierarchical';
        const mixerLayoutToggle = document.getElementById('mixerLayoutToggle');
        const optionA = document.getElementById('optionA');
        const optionB = document.getElementById('optionB');

        // Initialize toggle state
        mixerLayoutToggle.checked = useHierarchicalLayout;
        updateLayoutOptionDisplay();

        mixerLayoutToggle.addEventListener('change', () => {
            useHierarchicalLayout = mixerLayoutToggle.checked;
            localStorage.setItem('mixerLayout', useHierarchicalLayout ? 'hierarchical' : 'dynamic');
            updateLayoutOptionDisplay();
            showToast(useHierarchicalLayout ? '✓ Hierarchical layout enabled' : '✓ Dynamic layout enabled');
        });

        function updateLayoutOptionDisplay() {
            optionA.classList.toggle('active', !useHierarchicalLayout);
            optionB.classList.toggle('active', useHierarchicalLayout);
        }

        // ============ Guitar Pro Tabs Toggle ============
        const gpTabsToggle = document.getElementById('gpTabsToggle');
        if (gpTabsToggle) {
            // Load saved preference (default: true)
            const savedGP = localStorage.getItem('gpTabs');
            gpTabsToggle.checked = savedGP === null ? true : savedGP === 'true';

            gpTabsToggle.addEventListener('change', () => {
                localStorage.setItem('gpTabs', gpTabsToggle.checked.toString());
                showToast(gpTabsToggle.checked
                    ? '🎸 Guitar Pro tabs enabled - will generate .gp5 files'
                    : '⚡ Guitar Pro tabs disabled - faster processing'
                );
            });
        }

        // ============ Chord Detection Toggle ============
        const chordDetectionToggle = document.getElementById('chordDetectionToggle');
        if (chordDetectionToggle) {
            // Load saved preference (default: true)
            const savedChords = localStorage.getItem('chordDetection');
            chordDetectionToggle.checked = savedChords === null ? true : savedChords === 'true';

            chordDetectionToggle.addEventListener('change', () => {
                localStorage.setItem('chordDetection', chordDetectionToggle.checked.toString());
                showToast(chordDetectionToggle.checked
                    ? '🎵 Chord detection enabled - will analyze progressions'
                    : '⚡ Chord detection disabled - faster processing'
                );
            });
        }

        // Check Google Drive connection status
        async function checkDriveStatus() {
            const statusText = document.getElementById('driveStatusText');
            const statusDot = document.getElementById('driveDot');
            const connectBtn = document.getElementById('connectDriveBtn');
            const statsRow = document.getElementById('driveStatsRow');

            try {
                const response = await fetch(`${API_BASE}/drive/auth`);
                const data = await response.json();

                if (data.status === 'authenticated') {
                    statusText.textContent = 'Connected';
                    statusDot.className = 'status-dot green';
                    connectBtn.textContent = '✓ Connected to Google Drive';
                    connectBtn.disabled = true;

                    // Get stats
                    const statsResponse = await fetch(`${API_BASE}/drive/stats`);
                    const stats = await statsResponse.json();
                    if (stats.exists) {
                        statsRow.style.display = 'flex';
                        document.getElementById('driveFileCount').textContent = `${stats.folder_count} songs`;
                    }
                } else {
                    statusText.textContent = 'Not connected';
                    statusDot.className = 'status-dot red';
                    connectBtn.textContent = '🔗 Connect Google Drive';
                    connectBtn.disabled = false;
                }
            } catch (error) {
                statusText.textContent = 'Unavailable';
                statusDot.className = 'status-dot red';
                connectBtn.textContent = '⚠️ Install Drive libraries first';
                connectBtn.disabled = true;
            }
        }

        // Connect to Google Drive
        document.getElementById('connectDriveBtn').addEventListener('click', async () => {
            const btn = document.getElementById('connectDriveBtn');
            btn.textContent = '⏳ Authenticating...';
            btn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/drive/auth`);
                const data = await response.json();

                if (data.status === 'authenticated') {
                    showToast('✓ Connected to Google Drive!');
                    checkDriveStatus();
                } else {
                    showToast('Check terminal for auth link', true);
                    btn.textContent = '🔗 Complete auth in browser...';
                    // Poll for completion
                    setTimeout(checkDriveStatus, 5000);
                }
            } catch (error) {
                showToast('Connection failed: ' + error.message, true);
                btn.textContent = '🔗 Connect Google Drive';
                btn.disabled = false;
            }
        });

        // Load local storage stats
        async function loadLocalStats() {
            try {
                const response = await fetch(`${API_BASE}/jobs`);
                const data = await response.json();
                const jobCount = data.jobs?.length || 0;
                document.getElementById('localJobCount').textContent = `${jobCount} jobs`;

                // Estimate disk usage (rough estimate based on job count)
                const estimatedMB = jobCount * 25; // ~25MB per job average
                const maxMB = 1000; // Assume 1GB max for display
                const percent = Math.min((estimatedMB / maxMB) * 100, 100);
                document.getElementById('diskFill').style.width = `${percent}%`;
                document.getElementById('diskUsed').textContent = `~${estimatedMB} MB used`;
            } catch (error) {
                document.getElementById('localJobCount').textContent = 'Unable to fetch';
            }
        }

        // Cleanup old stems
        document.getElementById('cleanupBtn').addEventListener('click', async () => {
            const btn = document.getElementById('cleanupBtn');
            const originalText = btn.textContent;
            btn.textContent = '🔄 Cleaning up...';
            btn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/cleanup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ max_age_days: 7 })
                });
                const data = await response.json();

                if (data.freed_mb > 0) {
                    showToast(`✓ Freed ${data.freed_mb} MB (${data.deleted_files} files)`);
                } else {
                    showToast('✓ No old files to clean up');
                }
                loadLocalStats();
            } catch (error) {
                showToast('Cleanup failed: ' + error.message, true);
            }

            btn.textContent = originalText;
            btn.disabled = false;
        });

        // Toast notification
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');

            toastIcon.textContent = isError ? '⚠️' : '✓';
            toastMessage.textContent = message;
            toast.classList.toggle('error', isError);
            toast.classList.add('show');

            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Add estimated time display to processing section
        let processingStartTime = null;

        const originalStartProcessing = startProcessing;
        startProcessing = async function() {
            processingStartTime = Date.now();

            // Add ETA display if not exists
            let etaDisplay = document.querySelector('.eta-display');
            if (!etaDisplay) {
                etaDisplay = document.createElement('div');
                etaDisplay.className = 'eta-display';
                etaDisplay.innerHTML = 'Estimated time: <span class="eta-time">~10-15 min</span>';
                document.querySelector('.progress-container').after(etaDisplay);
            }

            await originalStartProcessing.call(this);
        };

        // Update ETA during processing
        const originalPollStatus = pollStatus;
        pollStatus = async function() {
            await originalPollStatus.call(this);

            // Update ETA based on progress
            const etaDisplay = document.querySelector('.eta-display');
            if (etaDisplay && processingStartTime) {
                const elapsed = (Date.now() - processingStartTime) / 1000 / 60; // minutes
                const progress = parseFloat(document.getElementById('progressText').textContent) || 0;

                if (progress > 5) {
                    const totalEstimate = elapsed / (progress / 100);
                    const remaining = Math.max(0, totalEstimate - elapsed);

                    if (remaining < 1) {
                        etaDisplay.innerHTML = 'Almost done... <span class="eta-time">< 1 min</span>';
                    } else {
                        etaDisplay.innerHTML = `Time remaining: <span class="eta-time">~${Math.ceil(remaining)} min</span>`;
                    }
                }
            }
        };
    </script>
</body>
</html>
